    <!DOCTYPE html>
    <html lang="zh-TW">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>ç¾é‡‘ç®¡ç†è¨ˆç®—å·¥å…· v1_final</title>
        <style>
            /* --- åŸºæœ¬æ¨£å¼å’Œè®Šæ•¸ (æ²¿ç”¨åŸç‰ˆ) --- */
            :root {
                --primary: #0d47a1; /* ä¸»è‰² */
                --primary-light: #1a73e8; /* ä¸»äº®è‰² */
                --secondary: #34a853; /* æ¬¡è¦è‰² (ç¶ ) */
                --tertiary: #fbbc05; /* ç¬¬ä¸‰è‰² (é»ƒ) */
                --danger: #ea4335; /* å±éšª/éŒ¯èª¤è‰² (ç´…) */
                --warning: #ff9800; /* è­¦å‘Šè‰² (æ©˜) */
                --light: #f8f9fa; /* æ·ºè‰²èƒŒæ™¯ */
                --dark: #202124; /* æ·±è‰²æ–‡å­— */
                --shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* é™°å½± */
                --radius: 8px; /* åœ“è§’ */

                /* é¢é¡é¡è‰²â”€â”€é è¨­ç‚ºä½ æŒ‡å®šçš„è‰²ç³» */
                --note-1000: #3D93F0; /* 1000 å…ƒ */
                --note-500:  #C6A27B; /* 500 å…ƒ */
                --note-100:  #DE4545; /* 100 å…ƒ */
                --coin-50:   #DAA520; /* 50 å…ƒ */
                --coin-10:   #453A3A; /* 10 å…ƒ */
                --coin-5:    #A3A3A3; /* 5 å…ƒ */
                --coin-1:    #790C0C; /* 1 å…ƒ */

                --success: #28a745; /* æˆåŠŸè‰² (ç¶ ) */
                --gray:    #6c757d; /* ç°è‰² */
            }
            * {box-sizing: border-box; margin: 0; padding: 0; font-family: 'Segoe UI', 'Microsoft JhengHei', sans-serif;}
            body {background-color: #f0f2f5; color: var(--dark); line-height: 1.6; padding: 0.5rem;} /* èª¿æ•´ body padding */
            .container {max-width: 960px; margin: 0 auto; padding: 0 1rem;}
            .header {text-align: center; margin: 1rem 0; color: var(--primary);}
            .header h1 {margin-bottom: 0.5rem;}
            .card {background: white; border-radius: var(--radius); box-shadow: var(--shadow); padding: 1rem; margin-bottom: 1rem; border-top: 4px solid var(--primary);} /* èª¿æ•´ card padding */
            .input-section {margin-bottom: 0.8rem;}
            .section-title {color: var(--primary); margin-bottom: 0.8rem; padding-bottom: 0.4rem; border-bottom: 2px solid var(--tertiary); font-size: 1.4rem; font-weight: 700;}
            .subsection-title {color: var(--secondary); margin-top: 1rem; margin-bottom: 0.6rem; font-size: 1.2rem; font-weight: 600; display: flex; align-items: center;}
            .subsection-title:before {content: ""; display: inline-block; width: 6px; height: 18px; background-color: var(--secondary); margin-right: 8px; border-radius: 3px;}
            .input-form {display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 0.8rem;}
            .input-group {margin-bottom: 0.8rem; position: relative;}
            .input-group label {display: block; margin-bottom: 0.4rem; font-weight: 600;}
            .input-flexbox {display: flex; gap: 0.5rem;}
            .bag-input {width: 15%; padding: 0.7rem 0.5rem; border: 2px solid #ddd; border-radius: var(--radius); font-size: 1rem; text-align: center; background-color: #f0f0f0;}
            .amount-input {width: 85%; padding: 0.7rem; border: 2px solid #ddd; border-radius: var(--radius); font-size: 1.1rem; transition: all 0.3s; background-color: #f9f9f9;}
            .input-group input:focus, .input-group select:focus {border-color: var(--primary-light); outline: none; box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2); background-color: white;}
            .input-error {border-color: var(--danger) !important; animation: pulse-error 1.5s infinite;}
            .error-message {color: var(--danger); font-size: 0.8rem; margin-top: 0.3rem; display: none;}
            .error-message.active {display: block; animation: fadeIn 0.3s;}
            .balance-error {animation: pulse-error 1.5s infinite;}
            .btn {background-color: var(--primary-light); color: white; border: none; border-radius: var(--radius); padding: 0.75rem 1.5rem; font-size: 1.1rem; cursor: pointer; transition: all 0.3s; display: inline-block; text-align: center; font-weight: 600; letter-spacing: 0.5px;}
            .btn:hover {background-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);}
            .btn:active {transform: translateY(0);}
            .btn-block {display: block; width: 100%;}
            .btn-clear {background-color: #6c757d; margin-bottom: 0.5rem;}
            .btn-clear:hover {background-color: #5a6268;}
            .btn-simulate {background-color: #28a745; margin-bottom: 1rem;}
            .btn-simulate:hover {background-color: #218838;}
            .btn-confirm {background-color: var(--primary-light); width: 100%;}
            .buttons-row {display: flex; gap: 0.5rem; margin-bottom: 1rem;}
            .buttons-row .btn {flex: 1;}
            .result-section {display: none;} /* é è¨­éš±è—ï¼Œè¨ˆç®—å¾Œé¡¯ç¤º */
            .result-section.active {display: block; animation: fadeIn 0.5s;}
            @keyframes fadeIn {from {opacity: 0; transform: translateY(10px);} to {opacity: 1; transform: translateY(0);}}
            @keyframes pulse-error {0% {box-shadow: 0 0 0 0 rgba(234, 67, 53, 0.4);} 70% {box-shadow: 0 0 0 6px rgba(234, 67, 53, 0);} 100% {box-shadow: 0 0 0 0 rgba(234, 67, 53, 0);}}
            .result-block {background-color: #f9f9f9; border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; border-left: 6px solid var(--tertiary); transition: all 0.3s;}
            .result-block:hover {box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);}
            .result-block-notes {border-left-color: var(--note-100);}
            .result-block-coins {border-left-color: var(--coin-10);}
            .warning-block {background-color: #fff3e0; border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; border-left: 6px solid var(--warning); position: relative; overflow: hidden;}
            .warning-block:after {content: "âš ï¸"; position: absolute; top: 10px; right: 10px; font-size: 1.5rem; opacity: 0.2;}
            .warning-title {color: var(--warning); font-weight: bold; margin-bottom: 0.6rem; font-size: 1.1rem; display: flex; align-items: center;}
            .warning-title:before {content: "âš ï¸"; margin-right: 6px;}
            .info-block {background-color: #e3f2fd; border-radius: var(--radius); padding: 1rem; margin-bottom: 1rem; border-left: 6px solid var(--primary-light); position: relative;}
            .info-block:after {content: "â„¹ï¸"; position: absolute; top: 10px; right: 10px; font-size: 1.5rem; opacity: 0.2;}
            .info-title {color: var(--primary); font-weight: bold; margin-bottom: 0.6rem; font-size: 1.1rem; display: flex; align-items: center;}
            .info-title:before {content: "â„¹ï¸"; margin-right: 6px;}
            .result-row {display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.6rem; padding-bottom: 0.6rem; border-bottom: 1px dashed #e0e0e0; line-height: 1.4;}
            .result-row:last-child {border-bottom: none; margin-bottom: 0; padding-bottom: 0;}
            .result-row .label {flex: 1; font-weight: 500;}
            .result-row .value {text-align: right; font-weight: 600; min-width: 160px;}
            .result-total {font-weight: bold; font-size: 1.15rem; color: var(--primary); border-top: 2px solid var(--tertiary); padding-top: 0.6rem; margin-top: 0.6rem;}
            .result-total .note {font-size: 0.8rem; color: #666; font-weight: normal; display: block; margin-top: 0.2rem;}
            .coin-detail {font-size: 0.95rem; color: #555; margin-top: 0.6rem; padding: 0.6rem; border-radius: var(--radius); background-color: #efefef; border-left: 3px solid #bbb;}
            .highlight {display: inline-block; background-color: #fff9e0; padding: 0.25rem 0.5rem; border-radius: 4px; font-weight: 600; margin: 0.2rem 0; border: 1px solid #ffe082;}
            .denomination {display: flex; align-items: center; margin-bottom: 6px;}
            .denom-icon {width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; margin-right: 10px; border-radius: 50%; font-weight: bold; color: white; font-size: 0.9rem; box-shadow: 0 2px 4px rgba(0,0,0,0.2);}
            .note-1000 {background-color: var(--note-1000);}
            .note-500 {background-color: var(--note-500);}
            .note-100 {background-color: var(--note-100);}
            .coin-50 {background-color: var(--coin-50);}
            .coin-10 {background-color: var(--coin-10);}
            .coin-5 {background-color: var(--coin-5);}
            .coin-1 {background-color: var(--coin-1);}
            .money-amount {font-size: 1.2rem; font-weight: 700; color: var(--primary);}
            .money-amount-1000 {color: var(--note-1000);}
            .money-amount-500 {color: var(--note-500);}
            .money-amount-100 {color: var(--note-100);}
            .money-amount-50 {color: var(--coin-50);}
            .money-amount-10 {color: var(--coin-10);}
            .money-amount-5 {color: var(--coin-5);}
            .money-amount-1 {color: var(--coin-1);}
            .money-count {background-color: #f0f0f0; padding: 0.15rem 0.4rem; border-radius: 4px; font-weight: 600; font-size: 0.9rem; margin-left: 6px; border: 1px solid #ddd;}
            
            /* ===== çµæœç¸½è¦½ (å·²èª¿æ•´) ===== */
            .summary-grid {display: grid; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.6rem;} /* èª¿æ•´ç¶²æ ¼ */
            .summary-box {
                display: flex;
                flex-direction: column;
                align-items: center;
                justify-content: center;
                background-color: #e8f0fe;
                border-radius: var(--radius);
                padding: 0.6rem; /* èª¿æ•´ padding */
                border: 1px solid #c0d6f9;
                text-align: center;
                transition: all 0.3s;
            }
            .summary-box.highlight-box {
                grid-column: span 3; /* è·¨ä¸‰æ¬„ */
                background-color: var(--secondary); /* æ·±ç¶ è‰²èƒŒæ™¯ */
                border-color: var(--secondary);
                color: white; /* ç™½è‰²æ–‡å­— */
            }
            .summary-box.highlight-box .summary-title,
            .summary-box.highlight-box .summary-value {
                color: white; /* ç¢ºä¿å¼·èª¿æ¡†å…§çš„æ–‡å­—å’Œæ•¸å€¼ç‚ºç™½è‰² */
            }
            .summary-title {font-weight: 600; font-size: 0.95rem; line-height: 1.2; white-space: nowrap;} /* èª¿æ•´å­—ç´šã€è¡Œé«˜ï¼Œç¦æ­¢æ›è¡Œ */
            .summary-value {font-size: 1.5rem; font-weight: 700; margin-top: 0.3rem; color: var(--primary);} /* èª¿æ•´å­—ç´šã€margin-top */
            .summary-box.error {background-color: #ffebee; border-color: #ffcdd2; animation: pulse-error 1.5s infinite;}

            /* ===== å½©è‰²æ¨™ç±¤æ¨£å¼ (æ–°å¢) ===== */
            .badge {
                padding: 4px 8px; /* å…§ç¸® */
                border-radius: 12px; /* åœ“è§’ */
                color: white; /* ç™½è‰²æ–‡å­— */
                font-weight: normal; /* ä¸åŠ ç²— */
                font-size: 0.9rem; /* è¼ƒå°å­—é«” */
                text-align: center;
                white-space: nowrap; /* é˜²æ­¢æ–‡å­—æ›è¡Œ */
                display: inline-flex; /* è®“å…§å®¹å±…ä¸­ */
                align-items: center;
                justify-content: center;
                min-width: 50px; /* ç¢ºä¿å°é¢é¡ä¹Ÿæœ‰ä¸€å®šå¯¬åº¦ */
            }
            /* å„é¢é¡å°æ‡‰çš„èƒŒæ™¯è‰² */
            .badge-1000 { background-color: var(--note-1000); }
            .badge-500 { background-color: var(--note-500); }
            .badge-100 { background-color: var(--note-100); }
            .badge-50 { background-color: var(--coin-50); }
            .badge-10 { background-color: var(--coin-10); }
            .badge-5 { background-color: var(--coin-5); }
            .badge-1 { background-color: var(--coin-1); }

            /* å¹£å€¼æ•¸å­—æ¨£å¼ */
            .badge-denom-value { /* é‡å° badge å…§éƒ¨å¯¦éš›é¢é¡æ•¸å­—çš„æ¨£å¼ */
                font-size: 1.4rem; /* åŠ å¤§å­—é«” */
                font-weight: normal; /* ä¸åŠ ç²— */
                /* margin-left: 5px; åƒ…ç•¶æœ‰é¡å¤–æ–‡å­—æ™‚éœ€è¦ */
            }

            /* ===== é€šç”¨çµæœå€å¡Š ===== */
            .result-block{background:#f9f9f9;border-radius:var(--radius);padding:1rem;margin-bottom:1rem;border-left:6px solid var(--tertiary);transition:all .3s;}
            .result-block:hover{box-shadow:0 2px 8px rgba(0,0,0,.1);}
            .result-row{display:flex;justify-content:space-between;align-items:center;margin-bottom:.6rem;padding-bottom:.6rem;border-bottom:1px dashed #e0e0e0;line-height:1.4;}
            .result-row:last-child{border-bottom:none;margin-bottom:0;padding-bottom:0;}
            .result-row .label{flex:1;font-weight:500;}
            .result-row .value{text-align:right;font-weight:600;min-width:160px;}
            .result-total{font-weight:bold;font-size:1.15rem;color:var(--primary);border-top:2px solid var(--tertiary);padding-top:.6rem;margin-top:.6rem;}
            .result-total .note{font-size:.8rem;color:#666;font-weight:normal;display:block;margin-top:.2rem;}

            /* ===== æŠ˜ç–Šæ¨™é¡Œã€å…§å®¹ CSS ï¼ˆè«‹æ•´æ®µè²¼åˆ° <style> åº•éƒ¨ï¼‰ ===== */
            .collapsible-header {
                cursor: pointer;
                display: flex;
                justify-content: space-between;
                align-items: center;
            }
            /* åœ¨æ¨™é¡Œå³å´è‡ªå‹•é¡¯ç¤º â–¼ï¼Œé»æ“Šæ™‚è½‰ 90Â° */
            .collapsible-header::after {
                content: "â–¼";
                font-size: 0.8rem;
                transition: transform 0.3s;
                margin-left: 0.5rem;
            }
            .collapsible-header.collapsed::after {
                transform: rotate(-90deg);
            }

            .collapsible-content {
                overflow: hidden;
                max-height: 0;
                transition: max-height 0.3s ease-in-out;
            }
            .collapsible-content:not(.collapsed) {
                max-height: 1000px; /* éš¨å…§å®¹é•·åº¦èª¿æ•´ï¼Œ1000px åªæ˜¯ç¤ºç¯„å€¼ */
            }
            /* ============================= */


            /* ç™¼å…‰æ©˜åˆ†éš”ç·š */
            hr.orange-separator {
                border: none;
                border-top: 3px solid var(--warning);
                box-shadow: 0 0 8px rgba(255, 168, 0, 0.7);
                margin: 0.8rem 0;
            }
            /* é ç•™é›¶ç”¨é‡‘å€å¡Šçš„é è¨­åˆ†éš”ç·š */
            hr.default {
                border: none;
                border-top: 2px solid #c0d6f9;
                margin: 0.8rem 0;
            }

            /* é›¶éŒ¢æ‰“åŒ…å€å¡Šçš„ç‰¹æ®Šé‡‘é¡çªå‡ºæ¨£å¼ */
            .highlight-amount-pack {
                font-size: 1.8rem; /* é¡¯è‘—æ”¾å¤§ */
                font-weight: 800; /* è¶…ç²—é«” */
                background-color: var(--tertiary); /* é»ƒè‰²èƒŒæ™¯ */
                color: var(--dark); /* æ·±è‰²æ–‡å­—ä»¥ç¢ºä¿å°æ¯” */
                padding: 0.2rem 0.6rem;
                border-radius: var(--radius);
                margin-right: 0.5rem; /* èˆ‡å¾Œæ–¹æ‹¬è™Ÿçš„é–“è· */
                display: inline-block; /* ç¢ºä¿ padding å’Œ margin ç”Ÿæ•ˆ */
            }

            /* ===== ä»£æ”¶ / PC é¡å¤–è¨ˆç®— ===== */
            .extra-calc {margin-top: 1rem;}
            .extra-calc-header {display: flex; align-items: center; background-color: var(--primary-light); color: white; padding: 0.8rem; border-radius: var(--radius) var(--radius) 0 0; font-weight: 600; cursor: pointer; justify-content: space-between;}
            .extra-calc-header-title {display: flex; align-items: center;}
            .extra-calc-header-icon {margin-left: 0.5rem; font-size: 0.8rem; transition: transform 0.3s;}
            .extra-calc-header-icon.collapsed {transform: rotate(-90deg);}
            .extra-calc-container {background-color: #f8f9fa; padding: 1rem; border-radius: 0 0 var(--radius) var(--radius); border: 1px solid #e9ecef; border-top: none; overflow: hidden; max-height: 1000px; transition: max-height 0.3s ease-in-out;}
            .extra-calc-container.collapsed {max-height: 0; padding: 0; border: 0;}
            .extra-calc-row {display: flex; flex-wrap: wrap; gap: 1rem; margin-bottom: 1rem;}
            .extra-calc-col {flex: 1; min-width: 0;}
            .extra-calc-col label {display: block; margin-bottom: 0.4rem; font-weight: 600; color: var(--dark);}
            .extra-calc-input {width: 100%; padding: 0.7rem; border: 2px solid #ddd; border-radius: var(--radius); font-size: 1rem;}
            .extra-calc-input:disabled {background-color: #e9ecef; color: var(--gray);}
            .extra-calc-result {text-align: center; padding: 0.8rem; background-color: #e8f5e9; border-radius: var(--radius); font-weight: bold; color: var(--success); font-size: 1.2rem; margin-top: 0.5rem;}
            .lock-btn {background-color: transparent; border: none; color: white; font-size: 1.2rem; cursor: pointer; padding: 0.2rem 0.5rem; border-radius: var(--radius); margin-left: 1rem; transition: all 0.3s;}
            .lock-btn:hover {background-color: rgba(255, 255, 255, 0.2);}
            .lock-btn.locked {color: var(--warning);}
            .calc-btn {margin-left: 0.5rem; padding: 0 0.6rem; background: var(--primary); color: #fff; border: none; border-radius: var(--radius); font-size: 1rem; height: 2.4rem; cursor: pointer;}
            .calc-btn:active {opacity: .8;}
            .explanation {margin-top: 1rem; font-size: 0.9rem; line-height: 1.5;}
            .explanation p {margin-bottom: 0.5rem;}
            .highlight-add {background: #d4edda; padding: 0 0.2rem; border-radius: 4px;}
            .highlight-sub {background: #f8d7da; padding: 0 0.2rem; border-radius: 4px;}

            /* --- æ¨¡æ…‹æ¡†é€šç”¨æ¨£å¼ (æ²¿ç”¨åŸç‰ˆ) --- */
            .modal {display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.4);}
            .modal-content {background-color: #fefefe; margin: 5% auto; padding: 0; border: 1px solid #888; width: 90%; max-width: 600px; border-radius: var(--radius); box-shadow: 0 4px 10px rgba(0,0,0,0.2); animation: slideDown 0.4s; overflow: hidden;}
            @keyframes slideDown {from {opacity: 0; transform: translateY(-30px);} to {opacity: 1; transform: translateY(0);}}
            .modal-header {background-color: var(--primary-light); color: white; padding: 0.8rem 1rem; display: flex; justify-content: space-between; align-items: center;}
            .modal-header h3 {margin: 0; font-size: 1.2rem;}
            .close {color: white; font-size: 24px; font-weight: bold; cursor: pointer; opacity: 0.8; line-height: 1;}
            .close:hover {opacity: 1;}
            .modal-body {padding: 1rem;}
            .manual-section h4 { margin-top: 1rem; margin-bottom: 0.5rem; color: var(--primary); }
            .manual-section p, .manual-section ul { margin-bottom: 0.8rem; }
            .manual-section ul { padding-left: 20px; }
            .table-container { overflow-x: auto; margin-bottom: 1rem; }
            table { width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; font-weight: bold; }
            tbody tr:nth-child(even) { background-color: #f9f9f9; }

            /* --- é¢é¡æ›ç®—æ¨¡æ…‹æ¡†ç‰¹å®šæ¨£å¼ (æ²¿ç”¨åŸç‰ˆ) --- */
            .exchange-section {margin-bottom: 1rem; padding-bottom: 1rem; border-bottom: 1px solid #eee;}
            .exchange-section:last-child {border-bottom: none; margin-bottom: 0;}
            .exchange-section h4 {margin: 0 0 0.8rem; color: var(--primary);}
            .exchange-field {margin-bottom: 1rem;}
            .exchange-field label {display: block; margin-bottom: 0.4rem; font-weight: 600;}
            .exchange-input { /* å°‡ .amount-input æ”¹ç‚º .exchange-input ä»¥é¿å…è¡çª */
                width: 100%; /* èª¿æ•´å¯¬åº¦ */
                padding: 0.7rem;
                border: 2px solid #ddd;
                border-radius: var(--radius);
                font-size: 1.1rem;
                transition: all 0.3s;
                background-color: #f9f9f9;
            }
            .exchange-input:focus {
                border-color: var(--primary-light);
                outline: none;
                box-shadow: 0 0 0 3px rgba(26, 115, 232, 0.2);
                background-color: white;
            }
            .exchange-select {width: 100%; padding: 0.7rem; border: 2px solid #ddd; border-radius: var(--radius); font-size: 1rem; background-color: #f9f9f9;}
            .exchange-info {background-color: #e8f0fe; padding: 1rem; border-radius: var(--radius); margin-top: 1rem;}
            .exchange-info div {margin-bottom: 0.4rem; line-height: 1.5;}
            .exchange-arrow {display: flex; justify-content: center; margin: 1rem 0; color: var(--primary); font-size: 2rem;}
            .btn-exchange {background-color: var(--primary-light); width: 100%; padding: 0.8rem; font-size: 1.2rem;}

            /* --- é ‚éƒ¨æŒ‰éˆ• (æ²¿ç”¨åŸç‰ˆ) --- */
            .info-btn {background-color: var(--primary-light); color: white; border: none; border-radius: var(--radius); padding: 0.4rem 0.8rem; margin: 0.4rem; font-size: 0.9rem; cursor: pointer; transition: all 0.3s; display: inline-block; text-align: center; font-weight: 600;}
            .info-btn:hover {background-color: var(--primary); transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);}
            .action-buttons {display: flex; justify-content: center; gap: 8px; margin: 12px 0 8px; flex-wrap: wrap;}

            /* --- éŸ¿æ‡‰å¼è¨­è¨ˆ (å·²èª¿æ•´) --- */
            @media (max-width: 768px) {
                .input-form {grid-template-columns: 1fr; gap: 0.5rem;}
                .result-row {flex-direction: column; align-items: flex-start;} /* èª¿æ•´å°é½Š */
                .result-row .value {text-align: left; margin-top: 3px; margin-left: 0px;} /* ç§»é™¤å·¦é‚Šè· */
                .summary-grid {grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); gap: 0.6rem;} /* èª¿æ•´ç‚º auto-fit */
                .summary-box {padding: 0.6rem;} /* èª¿æ•´ padding */
                .summary-title {font-size: 0.95rem; line-height: 1.2; white-space: nowrap;} /* ç¢ºä¿å–®è¡Œé¡¯ç¤º */
                .summary-value {font-size: 1.5rem; margin-top: 0.3rem;} /* èª¿æ•´å­—é«”å¤§å° */
                .modal-content {width: 95%; margin: 20px auto;}
                .action-buttons {flex-direction: row; gap: 4px;} /* æ”¹å›æ©«å‘æ’åˆ— */
                .info-btn {margin: 0.2rem;}
                .card {padding: 1rem; margin-bottom: 1rem;}
                .section-title {font-size: 1.3rem;}
                .subsection-title {font-size: 1.1rem;}
                .money-amount {font-size: 1.1rem;}
                .summary-value {font-size: 1.3rem;}
                .extra-calc-row {flex-direction: column; gap: 0.5rem;}
                .extra-calc-col {width: 100%;}
                .input-flexbox { flex-direction: row; } /* ç¢ºä¿è¢‹/æ†è¼¸å…¥æ¡†åœ¨å°è¢å¹•ä¹Ÿæ©«å‘ */
                .bag-input { width: 25%; } /* èª¿æ•´è¢‹/æ†è¼¸å…¥æ¡†å¯¬åº¦ */
                .amount-input { width: 75%; } /* èª¿æ•´é‡‘é¡è¼¸å…¥æ¡†å¯¬åº¦ */
            }
            @media (max-width: 480px) {
                .action-buttons {flex-direction: column; gap: 4px;} /* åœ¨æ›´å°è¢å¹•è®Šå›å‚ç›´ */
                .info-btn {width: 100%; margin: 0.2rem 0;}
            }

            /* ===== å¢æ·»è¨­è¨ˆ.md Styles Start ===== */
            /* ===== å…±é€šæ¨£å¼ ===== */
            body { /* Overriding body for font-family, ensure it does not conflict if Microsoft JhengHei is not available */
                font-family: \'Microsoft JhengHei\', \'Segoe UI\', sans-serif; /* Added Microsoft JhengHei as primary */
            }
            .item-list {
                list-style: none;
                padding: 0;
                margin: 0;
            }
            .item {
                display: flex;
                align-items: center;
                background: #fafafa;
                border: 1px solid #e0e0e0;
                border-radius: 6px;
                padding: 10px 12px;
                margin-bottom: 10px;
            }
            /* æ³¡æ³¡æ¨£å¼ï¼šè‡ªå‹•ç¸®æ”¾ + æœ€å°å°ºå¯¸ 36px */
            .denom-icon { /* This will override existing .denom-icon if any, or add new */
                display: inline-flex; /* æ”¹ç‚º inline-flex ä»¥æ›´å¥½åœ°æ§åˆ¶å…§éƒ¨å…ƒç´ å°é½Š */
                align-items: center;    /* å‚ç›´ç½®ä¸­æ³¡æ³¡å…§çš„æ–‡å­— */
                justify-content: center;/* æ°´å¹³ç½®ä¸­æ³¡æ³¡å…§çš„æ–‡å­— */
                min-width: 36px;
                height: 36px;
                padding: 0 8px;      /* å·¦å³å…§é‚Šè·ï¼Œè®“æ–‡å­—ä¸æœƒç·Šè²¼é‚Šç·£ */
                border-radius: 18px;      /* åŠé«˜å³ç‚ºåœ“è§’ï¼Œå¯è¦–å…§å®¹è‡ªå‹•æ‹‰é•· */
                color: #fff;
                font-weight: bold;
                font-size: 1rem;
                /* line-height: 36px;  ç”± flexbox align-items å–ä»£ */
                /* text-align: center; ç”± flexbox justify-content å–ä»£ */
                margin-right: 12px;
                flex-shrink: 0;
            }
            /* å°ç£å¯¦é«”å¹£å€¼å°æ‡‰è‰² (å¯è‡ªè¡Œèª¿æ•´) */
            .d1000 { background: var(--note-1000); }  /* 1000å…ƒ */
            .d500  { background: var(--note-500); }   /* 500å…ƒ */
            .d100  { background: var(--note-100); }   /* 100å…ƒ */
            .d50   { background: var(--coin-50); }   /* 50å…ƒ */
            .d10   { background: var(--coin-10); }   /* 10å…ƒ */
            .d5    { background: var(--coin-5); }   /* 5å…ƒ */
            .d1    { background: var(--coin-1); }   /* 1å…ƒ */

            /* é‡‘é¡æ–‡å­—ï¼šå­—é«” 1.2remã€ç²—é«” */
            .amount { /* This will override existing .amount if any, or add new */
                font-size: 1.2rem;
                font-weight: 700;
                margin-right: 12px;
            }
            /* ã€Œè¢‹ + æšå‰©é¤˜ã€æ¡†ï¼šæ·¡ç¶ åº•ã€ç²—é«”ã€é¿å…æ›è¡Œ */
            .meta {
                font-size: 1.0rem;
                font-weight: 600;
                background-color: #e8f5e9;
                color: #2c3e50;
                border: 1px solid #c8e6c9;
                border-radius: 4px;
                padding: 0.15rem 0.4rem;
                margin-left: auto;
                white-space: nowrap;
            }

            /* ===== æ–¹æ¡ˆäºŒç¨æœ‰ï¼šå…©æ¬„ Grid æ’ç‰ˆ ===== */
            .grid {
                display: flex;
                flex-wrap: wrap;
                gap: 16px;
            }
            .grid .item {
                width: calc(50% - 8px); /* å…©æ¬„ä¸¦æ’ï¼Œé–“è· 16px æ™‚ï¼Œæ¯æ¬„å¯¬åº¦ç‚º 50% æ¸›åŠé–“è· */
            }
            /* ===== å¢æ·»è¨­è¨ˆ.md Styles End ===== */

            /* ===== Custom Styles for Coin Packing Section ===== */
            .denom-icon-large {
                min-width: 43px;    /* åŸ 36px * 1.2 */
                height: 43px;       /* åŸ 36px * 1.2 */
                border-radius: 21.5px; /* åŸ 18px * 1.2 (approx) */
                font-size: 1.2rem;    /* åŸ 1rem * 1.2 */
                /* padding ä¿æŒ 0 8px æˆ–æŒ‰æ¯”ä¾‹èª¿æ•´ï¼Œä½† flex ç½®ä¸­æ›´é‡è¦ */
            }

            /* .highlight-amount-pack is already defined with yellow background (var(--tertiary)) */
            /* Ensuring it exists and is correct for the coin packing section amounts */
            /* .highlight-amount-pack {
                font-size: 1.8rem; 
                font-weight: 800; 
                background-color: var(--tertiary); 
                color: var(--dark); 
                padding: 0.2rem 0.6rem;
                border-radius: var(--radius);
                margin-right: 0.5rem; 
                display: inline-block; 
            } */

            .coin-pack-loose-count {
                font-size: 0.9rem; /* Slightly smaller than meta, or same as original (Xæš) */
                font-weight: 600;
                background-color: #e8f5e9; /* æ·¡ç¶ åº• from .meta */
                color: #2c3e50;           /* æ·±è‰²æ–‡å­— from .meta */
                border: 1px solid #c8e6c9;  /* é‚Šæ¡† from .meta */
                border-radius: 4px;         /* åœ“è§’ from .meta */
                padding: 0.15rem 0.4rem;    /* å…§è· from .meta */
                white-space: nowrap;
                margin-left: 0.5rem; /* Add some space from the amount */
            }

            .coin-pack-value-container {
                margin-left: auto; 
                display: flex; 
                align-items: center; 
                white-space: nowrap;
            }

            /* é›¶éŒ¢è™•ç†å€å¡Šå…§å°å‹é¢é¡åœ–ç¤ºçš„æ¨£å¼ */
            .denom-icon-small-breakdown {
                width:auto; 
                min-width:24px; 
                height:24px; 
                line-height:24px; 
                font-size:0.8rem; 
                padding: 0 5px; 
                margin-right:3px; 
                border-radius:12px;
            }

            /* è‡ªè¨‚é¡è‰² Modal æ¨£å¼ */
            .picker-group {
                display: flex;
                align-items: center;
                margin-bottom: 10px;
            }
            .picker-group label {
                flex-basis: 100px; /* æ¨™ç±¤å›ºå®šå¯¬åº¦ */
                margin-right: 10px;
                font-weight: 600;
            }
            .picker-group input[type="color"] {
                width: 60px; /* é¡è‰²é¸æ“‡å™¨å¯¬åº¦ */
                height: 30px;
                border: none;
                padding: 0;
                background: none;
                cursor: pointer;
            }
            .hex-value {
                margin-left: 10px;
                font-family: monospace;
                font-size: 0.9em;
                color: #555;
            }
        </style>
    </head>
    <body>
        <div class="container">
            <div class="header">
                <h1>ç¾é‡‘ç®¡ç†è¨ˆç®—å·¥å…·</h1>
                <p>è¼¸å…¥å„é¢é¡ç¸½é‡‘é¡ï¼Œç³»çµ±è‡ªå‹•è¨ˆç®—é›¶éŒ¢è™•ç†ã€é ç•™é›¶ç”¨é‡‘å’Œç‡Ÿæ”¶ä¸Šç¹³</p>
                <div class="action-buttons">
                    <button id="show-package-info" class="info-btn">ç¡¬å¹£&ç´™éˆ”åŒ…è£è³‡è¨Š</button>
                    <button id="show-manual" class="info-btn">æŸ¥çœ‹ä½¿ç”¨èªªæ˜</button>
                    <button id="show-exchange" class="info-btn">é¢é¡æ›ç®—å·¥å…·</button>
                    <button id="custom-color-btn" class="info-btn">è‡ªè¨‚é¢é¡é¡è‰²</button>
                </div>
            </div>

            <div class="card">
                <div class="input-section">
                    <div class="buttons-row">
                        <button id="clear-btn" class="btn btn-clear">æ¸…é™¤æ•¸å€¼</button>
                        <button id="simulate-btn" class="btn btn-simulate">æ¨¡æ“¬æ•¸å€¼</button>
                    </div>
                    <h2 class="section-title">è¼¸å…¥å„é¢é¡ç¸½é‡‘é¡</h2>
                    <div class="input-form">
                        <div class="input-group">
                            <div class="denomination">
                                <div class="denom-icon note-1000">1K</div>
                                <label for="amount1000">1000 å…ƒç¸½é‡‘é¡</label>
                            </div>
                            <input type="text" id="amount1000" data-denomination="1000" placeholder="ä¾‹å¦‚: 8000" inputmode="numeric" class="amount-input">
                            <div id="error1000" class="error-message">è«‹è¼¸å…¥1000çš„å€æ•¸</div>
                        </div>
                        <div class="input-group">
                            <div class="denomination">
                                <div class="denom-icon note-500">500</div>
                                <label for="amount500">500 å…ƒç¸½é‡‘é¡</label>
                            </div>
                            <input type="text" id="amount500" data-denomination="500" placeholder="ä¾‹å¦‚: 13000" inputmode="numeric" class="amount-input">
                            <div id="error500" class="error-message">è«‹è¼¸å…¥500çš„å€æ•¸</div>
                        </div>
                        <div class="input-group">
                            <div class="denomination">
                                <div class="denom-icon note-100">100</div>
                                <label for="amount100">100 å…ƒç¸½é‡‘é¡</label>
                            </div>
                            <div class="input-flexbox">
                                <input type="text" id="bundle100" data-package-type="bundle" data-denomination="100" placeholder="æ†" inputmode="numeric" class="bag-input">
                                <input type="text" id="amount100" data-denomination="100" placeholder="ä¾‹å¦‚: 7200" inputmode="numeric" class="amount-input">
                            </div>
                            <div id="error100" class="error-message">è«‹è¼¸å…¥100çš„å€æ•¸</div>
                        </div>
                        <div class="input-group">
                            <div class="denomination">
                                <div class="denom-icon coin-50">50</div>
                                <label for="amount50">50 å…ƒç¸½é‡‘é¡</label>
                            </div>
                            <div class="input-flexbox">
                                <input type="text" id="bag50" data-package-type="bag" data-denomination="50" placeholder="è¢‹" inputmode="numeric" class="bag-input">
                                <input type="text" id="amount50" data-denomination="50" placeholder="ä¾‹å¦‚: 1450" inputmode="numeric" class="amount-input">
                            </div>
                            <div id="error50" class="error-message">è«‹è¼¸å…¥50çš„å€æ•¸</div>
                        </div>
                        <div class="input-group">
                            <div class="denomination">
                                <div class="denom-icon coin-10">10</div>
                                <label for="amount10">10 å…ƒç¸½é‡‘é¡</label>
                            </div>
                            <div class="input-flexbox">
                                <input type="text" id="bag10" data-package-type="bag" data-denomination="10" placeholder="è¢‹" inputmode="numeric" class="bag-input">
                                <input type="text" id="amount10" data-denomination="10" placeholder="ä¾‹å¦‚: 720" inputmode="numeric" class="amount-input">
                            </div>
                            <div id="error10" class="error-message">è«‹è¼¸å…¥10çš„å€æ•¸</div>
                        </div>
                        <div class="input-group">
                            <div class="denomination">
                                <div class="denom-icon coin-5">5</div>
                                <label for="amount5">5 å…ƒç¸½é‡‘é¡</label>
                            </div>
                            <div class="input-flexbox">
                                <input type="text" id="bag5" data-package-type="bag" data-denomination="5" placeholder="è¢‹" inputmode="numeric" class="bag-input">
                                <input type="text" id="amount5" data-denomination="5" placeholder="ä¾‹å¦‚: 345" inputmode="numeric" class="amount-input">
                            </div>
                            <div id="error5" class="error-message">è«‹è¼¸å…¥5çš„å€æ•¸</div>
                        </div>
                        <div class="input-group">
                            <div class="denomination">
                                <div class="denom-icon coin-1">1</div>
                                <label for="amount1">1 å…ƒç¸½é‡‘é¡</label>
                            </div>
                            <div class="input-flexbox">
                                <input type="text" id="bag1" data-package-type="bag" data-denomination="1" placeholder="è¢‹" inputmode="numeric" class="bag-input">
                                <input type="text" id="amount1" data-denomination="1" placeholder="ä¾‹å¦‚: 321" inputmode="numeric" class="amount-input">
                            </div>
                            <div id="error1" class="error-message">è«‹è¼¸å…¥æ­£æ•´æ•¸</div>
                        </div>
                    </div>
                    <button id="calculate-btn" class="btn btn-block">è¨ˆç®—çµæœ</button>

                    <div class="extra-calc">
                        <div class="extra-calc-header" id="extraCalcHeader">
                            <div class="extra-calc-header-title">
                                ä»£æ”¶(+) â€” PC(-) é¡å¤–è¨ˆç®—
                                <span class="extra-calc-header-icon" id="extraCalcIcon">â–¼</span>
                            </div>
                            <button id="lock-btn" class="lock-btn" title="é–å®š/è§£é–è¼¸å…¥æ¡†">ğŸ”“</button>
                        </div>
                        <div class="extra-calc-container collapsed" id="extraCalcContainer">
                            <div class="extra-calc-row">
                                <div class="extra-calc-col">
                                    <label for="report-total">å ±è¡¨ç¸½é¡</label>
                                    <input type="text" id="report-total" placeholder="è¼¸å…¥å ±è¡¨ç¸½é¡" class="extra-calc-input" inputmode="numeric">
                                </div>
                                <div class="extra-calc-col">
                                    <label for="collect-amount">ç¸½é‡‘é¡</label>
                                    <div style="display:flex;align-items:center;">
                                        <input type="text" id="collect-amount" placeholder="è¼¸å…¥ç¸½é‡‘é¡" class="extra-calc-input" inputmode="numeric">
                                        <button type="button" class="calc-btn" onclick="importTotalAmount()">åŒ¯å…¥</button>
                                    </div>
                                </div>
                                <div class="extra-calc-col">
                                    <label for="pc-amount">PC ( - )ï¼š</label>
                                    <input type="text" id="pc-amount" placeholder="è¼¸å…¥ PC é‡‘é¡" inputmode="numeric" class="extra-calc-input">
                                </div>
                            </div>
                            <div class="extra-calc-result" id="extra-calc-result">è¨ˆç®—çµæœï¼š0 å…ƒ</div>
                            <div class="explanation">
                                <p><span class="highlight-add">ä»£æ”¶</span>ï¼šæ˜¯å…¨éƒ¨ç¸½é‡‘é¡ç¾é‡‘æœƒ <span class="highlight-add">å¤š</span>ï¼Œå¸³è¡¨ä¸ç”¨æ”¹</p>
                                <p><span class="highlight-sub">PC</span>ï¼šå¸³è¡¨ä¸Šçš„é‡‘é¡è¦ <span class="highlight-sub">æ¸›å»</span> PC çš„é‡‘é¡æ‰æ˜¯å¯¦éš›è¦çœ‹çš„æ•¸å€¼ã€‚</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="result-container" class="result-section">
                <div class="card compact-card">
                    <h2 class="section-title">çµæœç¸½è¦½</h2>
                    <div class="summary-grid">
                        <div class="summary-box highlight-box">
                            <div class="summary-title">å…¨éƒ¨ç¸½é‡‘é¡</div>
                            <div id="total-amount" class="summary-value">0 å…ƒ</div>
                        </div>
                        <div class="summary-box">
                            <div class="summary-title">é›¶éŒ¢è™•ç†ï¼ˆç§»å…¥ç‡Ÿæ”¶ï¼‰</div>
                            <div id="summary-small-coins" class="summary-value">0 å…ƒ</div>
                        </div>
                        <div id="petty-cash-box" class="summary-box">
                            <div class="summary-title">é ç•™é›¶ç”¨é‡‘</div>
                            <div id="petty-cash-actual" class="summary-value">20,000 å…ƒ</div>
                        </div>
                        <div class="summary-box">
                            <div class="summary-title">ç‡Ÿæ”¶ä¸Šç¹³</div>
                            <div id="summary-revenue" class="summary-value">0 å…ƒ</div>
                        </div>
                    </div>
                </div>

                <div class="card compact-card">
                    <h2 class="section-title">ç‡Ÿæ”¶ä¸Šç¹³</h2>
                    <div class="result-block">
                        <h3 class="subsection-title">ç´™éˆ”</h3>
                        <div id="revenue-notes">
                            </div>
                    </div>
                    <hr class="orange-separator"> <div class="result-block">
                        <h3 class="subsection-title">ç¡¬å¹£</h3>
                        <div id="revenue-coins">
                            </div>
                    </div>
                    <div class="result-block">
                        <div class="result-row result-total">
                            <div class="label">ç‡Ÿæ”¶ç¸½é¡</div>
                            <div id="revenue-amount" class="value">0 å…ƒ</div>
                        </div>
                    </div>
                </div>

                <div class="card compact-card">
                    <h2 class="section-title">é ç•™é›¶ç”¨é‡‘ï¼ˆç›®æ¨™ 20,000 å…ƒï¼‰</h2>
                    <div class="result-block">
                        <h3 class="subsection-title">ç´™éˆ”å¡«æ»¿</h3>
                        <div id="paper-money-detail">
                            </div>
                    </div>
                    <hr class="default"> <div class="result-block">
                        <h3 class="subsection-title">ä¿ç•™ç¡¬å¹£</h3>
                        <div id="kept-coins-detail">
                            </div>
                    </div>
                    <div id="balance-warning" class="warning-block" style="display: none;">
                        <div class="warning-title">æ³¨æ„ï¼</div>
                        <div id="balance-warning-text"></div>
                    </div>
                    <div class="result-block compact-block">
                        <div class="result-row result-total">
                            <div class="label">é ç•™é›¶ç”¨é‡‘å¯¦éš›ç¸½é¡ï¼š</div>
                            <div id="petty-cash-final" class="value money-amount">0 å…ƒ</div>
                        </div>
                    </div>
                </div>

                <div class="card compact-card">
                    <h2 class="section-title collapsible-header collapsed" id="smallCoinsHeader">é›¶éŒ¢è™•ç† â†’ ç§»å…¥ã€Œç‡Ÿæ”¶ã€</h2>
                    <div class="collapsible-content collapsed" id="smallCoinsContent">
                        <div class="result-block compact-block result-block-coins">
                            <div class="result-row compact-row">
                                <div class="label">å››ç¨®ç¡¬å¹£åˆè¨ˆï¼ˆ50+10+5+1ï¼‰ï¼š</div>
                                <div id="total-coins" class="value money-amount">0 å…ƒ</div>
                            </div>
                            <div class="result-row compact-row">
                                <div class="label">å¤šå‡ºå…©ä½æ•¸ï¼ˆmod 100ï¼‰ï¼š</div>
                                <div id="remainder-coins" class="value money-amount">0 å…ƒ</div>
                            </div>
                            <div class="result-row result-total">
                                <div class="label">ç§»å…¥ç‡Ÿæ”¶çš„é›¶éŒ¢ï¼š</div>
                                <div id="moved-coins" class="value money-amount">0 å…ƒ</div>
                            </div>
                            <div class="coin-detail" id="coin-breakdown">
                                </div>
                        </div>
                    </div>
                </div>

                <div class="card compact-card">
                    <h2 class="section-title">é›¶éŒ¢æ‰“åŒ…</h2>
                    <div class="result-block" id="coin-pack-block">
                        </div>
                </div>

            </div>
        </div>

        <div id="package-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>ç¡¬å¹£ & ç´™éˆ”åŒ…è£è³‡è¨Š</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="manual-section">
                        <h4>ç¡¬å¹£è¢‹è£æ›ç®—è¡¨</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>é¢é¡</th>
                                        <th>æ¯è¢‹æ•¸é‡</th>
                                        <th>æ¯è¢‹é‡‘é¡</th>
                                        <th>å‚™è¨»</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>50å…ƒ</strong></td>
                                        <td>40æš</td>
                                        <td>2,000å…ƒ</td>
                                        <td>æ¯è¢‹40æšè£</td>
                                    </tr>
                                    <tr>
                                        <td><strong>10å…ƒ</strong></td>
                                        <td>50æš</td>
                                        <td>500å…ƒ</td>
                                        <td>æ¯è¢‹50æšè£</td>
                                    </tr>
                                    <tr>
                                        <td><strong>5å…ƒ</strong></td>
                                        <td>50æš</td>
                                        <td>250å…ƒ</td>
                                        <td>æ¯è¢‹50æšè£</td>
                                    </tr>
                                    <tr>
                                        <td><strong>1å…ƒ</strong></td>
                                        <td>100æš</td>
                                        <td>100å…ƒ</td>
                                        <td>æ¯è¢‹100æšè£</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <h4>ç´™éˆ”æ†è£æ›ç®—è¡¨</h4>
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>é¢é¡</th>
                                        <th>æ¯æ†æ•¸é‡</th>
                                        <th>æ¯æ†é‡‘é¡</th>
                                        <th>å‚™è¨»</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>1000å…ƒ</strong></td>
                                        <td>-</td>
                                        <td>-</td>
                                        <td>ç„¡éœ€æ†åŒ…</td>
                                    </tr>
                                    <tr>
                                        <td><strong>500å…ƒ</strong></td>
                                        <td>20å¼µ</td>
                                        <td>10,000å…ƒ</td>
                                        <td>ä¸é™åˆ¶10,000å…ƒä¸€æ†</td>
                                    </tr>
                                    <tr>
                                        <td><strong>100å…ƒ</strong></td>
                                        <td>20å¼µ</td>
                                        <td>2,000å…ƒ</td>
                                        <td>å¼·åˆ¶2,000å…ƒä¸€æ†</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="manual-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>POSæ©Ÿç®—éŒ¢-èªªæ˜æ–‡ä»¶</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body" style="max-height: 70vh; overflow-y: auto; padding-right: 10px;">
                    <div class="manual-section">
                        <h4>ä¸€ã€åŠŸèƒ½ç°¡ä»‹</h4>
                        <p>ç¾é‡‘ç®¡ç†è¨ˆç®—å·¥å…·å°ˆç‚ºé›¶å”®æ¥­ã€é¤é£²æ¥­ç­‰éœ€è¦è™•ç†å¤§é‡ç¾é‡‘äº¤æ˜“çš„ä¼æ¥­è¨­è¨ˆï¼Œèƒ½å¤ è‡ªå‹•åŒ–è™•ç†æ—¥å¸¸ç‡Ÿæ¥­çµæŸå¾Œçš„ç¾é‡‘ç›¤é»ã€é›¶ç”¨é‡‘åˆ†é…èˆ‡ç‡Ÿæ”¶ä¸Šç¹³ã€‚</p>
                    </div>

                    <div class="manual-section">
                        <h4>äºŒã€è¨ˆç®—è¦å‰‡</h4>

                        <h5>1. é›¶éŒ¢è™•ç†</h5>
                        <p>è™•ç†é›¶éŒ¢è¦å‰‡å¦‚ä¸‹ï¼š</p>
                        <ul>
                            <li>è¨ˆç®—å››ç¨®ç¡¬å¹£ï¼ˆ50å…ƒã€10å…ƒã€5å…ƒã€1å…ƒï¼‰ç¸½é‡‘é¡</li>
                            <li>å¾ä¸­æå–ä¸è¶³100å…ƒçš„é›¶éŒ¢ï¼ˆmod 100çš„é¤˜æ•¸ï¼‰</li>
                            <li>å°‡é€™äº›é›¶éŒ¢ç§»å…¥ç‡Ÿæ”¶ä¸Šç¹³éƒ¨åˆ†ï¼Œä¸è¨ˆå…¥é ç•™é›¶ç”¨é‡‘</li>
                        </ul>

                        <h5>2. é ç•™é›¶ç”¨é‡‘ï¼ˆå›ºå®š20,000å…ƒï¼‰</h5>
                        <p>é ç•™é›¶ç”¨é‡‘çš„çµ„æˆè¦å‰‡ï¼š</p>
                        <ul>
                            <li><strong>ç¡¬å¹£éƒ¨åˆ†</strong>ï¼šä¿ç•™æ‰€æœ‰å¯æ•´é™¤100å…ƒçš„ç¡¬å¹£ç¸½é¡</li>
                            <li><strong>ç´™éˆ”éƒ¨åˆ†</strong>ï¼šå„ªå…ˆå°‹æ‰¾èƒ½å¤ ä½¿é ç•™é›¶ç”¨é‡‘æ°å¥½ç‚º20,000å…ƒçš„500å…ƒèˆ‡100å…ƒçµ„åˆ</li>
                        </ul>

                        <h5>3. ç‡Ÿæ”¶ä¸Šç¹³</h5>
                        <p>ç‡Ÿæ”¶ä¸Šç¹³é‡‘é¡ = å…¨éƒ¨ç¸½é‡‘é¡ - é ç•™é›¶ç”¨é‡‘å¯¦éš›é‡‘é¡</p>
                    </div>

                    <div class="manual-section">
                        <h4>ä¸‰ã€é¢é¡æ›ç®—åŠŸèƒ½</h4>
                        <p>å¯ä»¥å°‡æŸä¸€é¢é¡çš„é‡‘é¡å¿«é€Ÿè½‰æ›ç‚ºå…¶ä»–é¢é¡ï¼Œä¸¦è‡ªå‹•æ›´æ–°åˆ°è¼¸å…¥æ¡†ä¸­ï¼š</p>
                        <ul>
                            <li>é¸æ“‡è¦è½‰å‡ºçš„é¢é¡å’Œè½‰å…¥çš„ç›®æ¨™é¢é¡</li>
                            <li>è¼¸å…¥è¦è½‰æ›çš„é‡‘é¡</li>
                            <li>ç¢ºèªè½‰æ›å¾Œï¼Œç³»çµ±æœƒè‡ªå‹•æ›´æ–°è¼¸å…¥æ¡†ä¸­çš„é‡‘é¡</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="exchange-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>é¢é¡æ›ç®—å·¥å…·</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <div class="exchange-section">
                        <h4>è½‰å‡ºé¢é¡</h4>
                        <div class="exchange-field">
                            <label for="exchange-amount">é‡‘é¡</label>
                            <input type="text" id="exchange-amount" placeholder="è¼¸å…¥è¦è½‰æ›çš„é‡‘é¡" class="exchange-input" inputmode="numeric">
                        </div>
                        <div class="exchange-field">
                            <label for="exchange-from">é¸æ“‡é¢é¡</label>
                            <select id="exchange-from" class="exchange-select">
                                <option value="1000" selected>1000å…ƒ</option>
                                <option value="500">500å…ƒ</option>
                                <option value="100">100å…ƒ</option>
                                <option value="50">50å…ƒ</option>
                                <option value="10">10å…ƒ</option>
                                <option value="5">5å…ƒ</option>
                                <option value="1">1å…ƒ</option>
                            </select>
                        </div>
                        <div class="exchange-info">
                            <div>ç•¶å‰é¢é¡ç¸½é¡: <span id="from-current-amount">0</span> å…ƒ</div>
                            <div>(æ•¸é‡: <span id="from-current-count">0</span> å¼µ/æš)</div>
                            <hr style="margin: 5px 0;">
                            <div>è½‰æ›å¾Œå‰©é¤˜é‡‘é¡: <span id="from-new-amount">0</span> å…ƒ</div>
                            <div>(æ•¸é‡: <span id="from-new-count">0</span> å¼µ/æš)</div>
                        </div>
                    </div>

                    <div class="exchange-arrow">â†’</div>

                    <div class="exchange-section">
                        <h4>è½‰å…¥é¢é¡</h4>
                        <div class="exchange-field">
                            <label for="exchange-to">é¸æ“‡é¢é¡</label>
                            <select id="exchange-to" class="exchange-select">
                                <option value="1000">1000å…ƒ</option>
                                <option value="500">500å…ƒ</option>
                                <option value="100">100å…ƒ</option>
                                <option value="50">50å…ƒ</option>
                                <option value="10">10å…ƒ</option>
                                <option value="5">5å…ƒ</option>
                                <option value="1" selected>1å…ƒ</option>
                            </select>
                        </div>
                        <div class="exchange-info">
                            <div>ç•¶å‰é¢é¡ç¸½é¡: <span id="to-current-amount">0</span> å…ƒ</div>
                            <div>(æ•¸é‡: <span id="to-current-count">0</span> å¼µ/æš)</div>
                            <hr style="margin: 5px 0;">
                            <div>è½‰æ›å¾Œç¸½é‡‘é¡: <span id="to-new-amount">0</span> å…ƒ</div>
                            <div>(æ•¸é‡: <span id="to-new-count">0</span> å¼µ/æš)</div>
                        </div>
                    </div>

                    <button id="exchange-confirm" class="btn btn-confirm btn-exchange">ç¢ºèªè½‰æ›</button>
                </div>
            </div>
        </div>

        <!-- ===== é¢é¡é¡è‰²è‡ªè¨‚ Modal ===== -->
        <div id="color-modal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3>è‡ªè¨‚é¢é¡é¡è‰²</h3>
                    <span class="close">&times;</span>
                </div>
                <div class="modal-body">
                    <!-- è‰²ç¥¨ -->
                    <div class="picker-group"><label>1000 å…ƒ:</label><input type="color" id="pick-1000"><span id="hex-1000" class="hex-value"></span></div>
                    <div class="picker-group"><label>500 å…ƒ:</label> <input type="color" id="pick-500"> <span id="hex-500"  class="hex-value"></span></div>
                    <div class="picker-group"><label>100 å…ƒ:</label> <input type="color" id="pick-100"> <span id="hex-100"  class="hex-value"></span></div>
                    <div class="picker-group"><label>50 å…ƒ:</label>  <input type="color" id="pick-50">  <span id="hex-50"   class="hex-value"></span></div>
                    <div class="picker-group"><label>10 å…ƒ:</label>  <input type="color" id="pick-10">  <span id="hex-10"   class="hex-value"></span></div>
                    <div class="picker-group"><label>5 å…ƒ:</label>   <input type="color" id="pick-5">   <span id="hex-5"    class="hex-value"></span></div>
                    <div class="picker-group"><label>1 å…ƒ:</label>   <input type="color" id="pick-1">   <span id="hex-1"    class="hex-value"></span></div>

                    <div style="display:flex;gap:8px;margin-top:16px;">
                        <button id="reset-colors" class="btn btn-clear" style="flex:1;">ä¸€éµé‚„åŸé è¨­è‰²</button>
                        <button id="close-color-modal" class="btn btn-simulate" style="flex:1;">å®Œæˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <script>
            document.addEventListener('DOMContentLoaded', function() {
                // --- å¸¸æ•¸å®šç¾© ---
                const packagingRules = {
                    'bundle100': { value: 2000, count: 20 }, // 100å…ƒæ†
                    'bag50': { value: 2000, count: 40 },     // 50å…ƒè¢‹
                    'bag10': { value: 500, count: 50 },      // 10å…ƒè¢‹
                    'bag5': { value: 250, count: 50 },       // 5å…ƒè¢‹
                    'bag1': { value: 100, count: 100 }       // 1å…ƒè¢‹
                };
                const denominations = [1000, 500, 100, 50, 10, 5, 1]; // é¢é¡åˆ—è¡¨

                // --- DOM å…ƒç´ ç²å– ---
                const amountInputs = {}; // ä¸»é é¢é‡‘é¡è¼¸å…¥æ¡†
                const bagInputs = {};    // ä¸»é é¢è¢‹/æ†è¼¸å…¥æ¡†
                denominations.forEach(denom => {
                    amountInputs[denom] = document.getElementById(`amount${denom}`);
                    const bagInput = document.getElementById(`bag${denom}`) || document.getElementById(`bundle${denom}`);
                    if (bagInput) {
                        bagInputs[denom] = bagInput;
                    }
                });

                const resultContainer = document.getElementById('result-container');
                const clearBtn = document.getElementById('clear-btn');
                const simulateBtn = document.getElementById('simulate-btn');
                const calculateBtn = document.getElementById('calculate-btn');

                // é¡å¤–è¨ˆç®—å€å¡Š
                const extraCalcHeader = document.getElementById('extraCalcHeader'); // ç²å–é¡å¤–è¨ˆç®—å€å¡Šçš„é ­éƒ¨å…ƒç´ 
                const extraCalcContainer = document.getElementById('extraCalcContainer'); // ç²å–é¡å¤–è¨ˆç®—å€å¡Šçš„å®¹å™¨å…ƒç´ 
                const extraCalcIcon = document.getElementById('extraCalcIcon'); // ç²å–é¡å¤–è¨ˆç®—å€å¡Šçš„åœ–ç¤ºå…ƒç´ 
                const lockBtn = document.getElementById('lock-btn');
                const reportTotalInput = document.getElementById('report-total');
                const collectAmountInput = document.getElementById('collect-amount');
                const pcAmountInput = document.getElementById('pc-amount');
                const extraCalcResult = document.getElementById('extra-calc-result');
                const extraCalcInputs = [reportTotalInput, collectAmountInput, pcAmountInput];

                // æ¨¡æ…‹æ¡†
                const packageModal = document.getElementById('package-modal');
                const manualModal = document.getElementById('manual-modal');
                const exchangeModal = document.getElementById('exchange-modal');
                const showPackageBtn = document.getElementById('show-package-info');
                const showManualBtn = document.getElementById('show-manual');
                const showExchangeBtn = document.getElementById('show-exchange');
                const closeBtns = document.querySelectorAll('.modal .close'); // æ›´ç²¾ç¢ºé¸æ“‡é—œé–‰æŒ‰éˆ•

                // é¢é¡æ›ç®—æ¨¡æ…‹æ¡†å…ƒç´ 
                const exchangeAmountInput = document.getElementById('exchange-amount');
                const exchangeFromSelect = document.getElementById('exchange-from');
                const exchangeToSelect = document.getElementById('exchange-to');
                const exchangeConfirmBtn = document.getElementById('exchange-confirm');
                const fromCurrentAmountSpan = document.getElementById('from-current-amount');
                const fromCurrentCountSpan = document.getElementById('from-current-count');
                const fromNewAmountSpan = document.getElementById('from-new-amount');
                const fromNewCountSpan = document.getElementById('from-new-count');
                const toCurrentAmountSpan = document.getElementById('to-current-amount');
                const toCurrentCountSpan = document.getElementById('to-current-count');
                const toNewAmountSpan = document.getElementById('to-new-amount');
                const toNewCountSpan = document.getElementById('to-new-count');

                // --- æ ¼å¼åŒ–èˆ‡è§£æå‡½æ•¸ ---

                /**
                 * æ ¼å¼åŒ–æ•¸å­—ç‚ºè²¨å¹£å­—ä¸² (ä¾‹å¦‚: 1,234 å…ƒ)
                 * @param {number} number - è¦æ ¼å¼åŒ–çš„æ•¸å­—
                 * @returns {string} æ ¼å¼åŒ–å¾Œçš„å­—ä¸²
                 */
                function formatMoney(number) {
                    if (isNaN(number)) return '0 å…ƒ';
                    return new Intl.NumberFormat('zh-TW').format(number) + ' å…ƒ';
                }

                /**
                 * æ ¼å¼åŒ–æ•¸å­—ç‚ºåŒ…å«åƒåˆ†ä½çš„å­—ä¸² (ä¾‹å¦‚: 1,234)
                 * @param {number | string} number - è¦æ ¼å¼åŒ–çš„æ•¸å­—æˆ–å­—ä¸²
                 * @returns {string} æ ¼å¼åŒ–å¾Œçš„å­—ä¸²
                 */
                function formatNumber(number) {
                    const num = parseFloat(String(number).replace(/,/g, ''));
                    if (isNaN(num)) return '';
                    return new Intl.NumberFormat('zh-TW').format(num);
                }

                 /**
                 * è§£æè¼¸å…¥æ¡†çš„å€¼ç‚ºæ•¸å­— (å»é™¤é€—è™Ÿ)
                 * @param {string} input - è¼¸å…¥æ¡†çš„å€¼
                 * @returns {number} è§£æå¾Œçš„æ•¸å­—ï¼Œè‹¥ç„¡æ•ˆå‰‡è¿”å› 0
                 */
                function parseInputValue(input) {
                    if (typeof input !== 'string') return 0;
                    return parseInt(input.replace(/,/g, ''), 10) || 0;
                }

                /**
                 * æ ¼å¼åŒ–è¼¸å…¥æ¡†çš„å€¼ (å³æ™‚æ·»åŠ åƒåˆ†ä½)
                 * @param {HTMLInputElement} inputElement - è¼¸å…¥æ¡†å…ƒç´ 
                 */
                function formatInputWithCommas(inputElement) {
                     // è¨˜éŒ„ç•¶å‰å…‰æ¨™ä½ç½®
                    let cursorPosition = inputElement.selectionStart;
                    const originalLength = inputElement.value.length;

                    let value = inputElement.value.replace(/[^\d]/g, ''); // åªä¿ç•™æ•¸å­—
                    value = value.replace(/^0+/, ''); // ç§»é™¤é–‹é ­çš„é›¶

                    const formattedValue = value ? formatNumber(value) : '';

                    // è¨ˆç®—æ ¼å¼åŒ–å‰å¾Œé•·åº¦å·®ç•°ï¼Œä»¥èª¿æ•´å…‰æ¨™ä½ç½®
                    const lengthDifference = formattedValue.length - originalLength;

                    inputElement.value = formattedValue;

                    // æ¢å¾©å…‰æ¨™ä½ç½®
                    // å¦‚æœå€¼è®Šé•·ï¼ˆåŠ äº†é€—è™Ÿï¼‰ï¼Œå…‰æ¨™å‘å³ç§»å‹•ç›¸æ‡‰ä½æ•¸
                    // å¦‚æœå€¼è®ŠçŸ­ï¼ˆåˆªäº†æ•¸å­—ï¼‰ï¼Œå…‰æ¨™å¯èƒ½éœ€è¦èª¿æ•´ï¼Œé€™è£¡ç°¡å–®è™•ç†
                    const newCursorPosition = cursorPosition + lengthDifference;
                     // ç¢ºä¿å…‰æ¨™ä½ç½®æœ‰æ•ˆ
                    if (newCursorPosition >= 0 && newCursorPosition <= formattedValue.length) {
                        inputElement.setSelectionRange(newCursorPosition, newCursorPosition);
                    }
                }


                // --- æ ¸å¿ƒè¨ˆç®—é‚è¼¯ ---

                /**
                 * åå‘è¿­ä»£æ³•æŸ¥æ‰¾æœ€ä½³é¢é¡çµ„åˆ (å„ªå…ˆä½¿ç”¨100å…ƒ)
                 * @param {number} remainingCashNeeded - éœ€è¦ç”¨100å’Œ500å…ƒè£œè¶³çš„é‡‘é¡
                 * @param {number} available100Count - å¯ç”¨çš„100å…ƒå¼µæ•¸
                 * @param {number} available500Count - å¯ç”¨çš„500å…ƒå¼µæ•¸
                 * @returns {object} åŒ…å«æ‰¾åˆ°çµæœ(found)ã€ä½¿ç”¨çš„100å…ƒå¼µæ•¸(used100)ã€ä½¿ç”¨çš„500å…ƒå¼µæ•¸(used500)ã€100å…ƒç¸½é¡(amount100)ã€500å…ƒç¸½é¡(amount500)
                 */
                function findOptimalCombination(remainingCashNeeded, available100Count, available500Count) {
                    let optimal100 = 0;
                    let optimal500 = 0;
                    let found = false;

                    // å¾æœ€å¤§å¯ç”¨100å…ƒå¼µæ•¸é–‹å§‹éæ¸›
                    for (let i = available100Count; i >= 0; i--) {
                        const amount100 = i * 100;
                        const remainingFor500 = remainingCashNeeded - amount100;

                        // æª¢æŸ¥å‰©é¤˜é‡‘é¡æ˜¯å¦ç‚º500çš„å€æ•¸ä¸”å¤§æ–¼ç­‰æ–¼0
                        if (remainingFor500 >= 0 && remainingFor500 % 500 === 0) {
                            const needed500Count = remainingFor500 / 500;

                            // æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ çš„500å…ƒ
                            if (needed500Count <= available500Count) {
                                optimal100 = i;
                                optimal500 = needed500Count;
                                found = true;
                                break; // æ‰¾åˆ°æœ€ä½³çµ„åˆï¼Œåœæ­¢è¿´åœˆ
                            }
                        }
                    }

                    return {
                        found,
                        used100: optimal100,
                        used500: optimal500,
                        amount100: optimal100 * 100,
                        amount500: optimal500 * 500
                    };
                }

                 /**
                 * è¨ˆç®—é›¶éŒ¢æ˜ç´°
                 * @param {number} targetAmount - è¦çµ„æˆçš„é›¶éŒ¢ç¸½é¡
                 * @param {object} availableAmounts - å„é¢é¡ç•¶å‰å¯ç”¨ç¸½é‡‘é¡ (ä»¥é‡‘é¡è¡¨ç¤º)
                 * @returns {object} å„é¢é¡ä½¿ç”¨çš„æšæ•¸ { '50': count, '10': count, ... }
                 */
                function getCoinsBreakdown(targetAmount, availableAmounts) {
                    let remaining = targetAmount;
                    const coinDenominations = [50, 10, 5, 1]; // ç¡¬å¹£é¢é¡ç”±å¤§åˆ°å°æ’åˆ—
                    const result = { '50': 0, '10': 0, '5': 0, '1': 0 };

                    for (const denom of coinDenominations) {
                        const denomStr = denom.toString();
                        // è¨ˆç®—è©²é¢é¡æœ€å¤šå¯ç”¨çš„æšæ•¸
                        const availableCount = Math.floor(availableAmounts[denomStr] / denom);
                        // è¨ˆç®—éœ€è¦å¤šå°‘æšè©²é¢é¡çš„ç¡¬å¹£
                        const neededCount = Math.floor(remaining / denom);
                        // å¯¦éš›ä½¿ç”¨çš„æšæ•¸æ˜¯å¯ç”¨å’Œéœ€è¦ä¹‹é–“çš„æœ€å°å€¼
                        const usedCount = Math.min(availableCount, neededCount);

                        result[denomStr] = usedCount;
                        remaining -= usedCount * denom;

                        if (remaining <= 0) break; // é‡‘é¡å·²æ¹Šé½Š
                    }

                    // å¦‚æœç„¡æ³•å®Œå…¨æ¹Šé½Š (ç†è«–ä¸Šç”¨ 1 å…ƒä¸€å®šå¯ä»¥)ï¼Œé€™è£¡å¯ä»¥åŠ éŒ¯èª¤è™•ç†
                     if (remaining > 0) {
                        console.warn(`ç„¡æ³•å®Œå…¨æ¹Šé½Šé›¶éŒ¢ ${targetAmount}ï¼Œå‰©é¤˜ ${remaining}`);
                        // ç†è«–ä¸Šå› ç‚ºæœ‰1å…ƒé¢é¡ï¼Œæ­¤è™•æ‡‰ä¸æœƒç™¼ç”Ÿ
                    }

                    return result;
                }


                /**
                 * è¨ˆç®—æŒ‡å®šé¢é¡çš„è¢‹/æ†æ•¸å’Œæ•£è£æ•¸é‡
                 * @param {number} totalCount - è©²é¢é¡ç¸½æš/å¼µæ•¸
                 * @param {number} denomination - é¢é¡å€¼
                 * @returns {object} åŒ…å«è¢‹/æ†æ•¸(packages)ã€æ•£è£æ•¸(loose)ã€æ•£è£é‡‘é¡(looseAmount)
                 */
                function calculatePackages(totalCount, denomination) {
                    let packageKey = '';
                    if (denomination === 100) packageKey = 'bundle100';
                    else if (denomination === 50) packageKey = 'bag50';
                    else if (denomination === 10) packageKey = 'bag10';
                    else if (denomination === 5) packageKey = 'bag5';
                    else if (denomination === 1) packageKey = 'bag1';
                    else return { packages: 0, loose: totalCount, looseAmount: totalCount * denomination }; // éæ‰“åŒ…é¢é¡ï¼Œç›´æ¥è¿”å›åŸæ•¸é‡

                    const rule = packagingRules[packageKey];
                    if (!rule) return { packages: 0, loose: totalCount, looseAmount: totalCount * denomination }; // è‹¥ç„¡å°æ‡‰è¦å‰‡ï¼ŒåŒæ¨£è¿”å›åŸæ•¸é‡

                    const packages = Math.floor(totalCount / rule.count); // è¨ˆç®—å¯æ‰“åŒ…çš„æ•¸é‡
                    const loose = totalCount % rule.count; // è¨ˆç®—æ•£è£çš„æ•¸é‡
                    const looseAmount = loose * denomination; // è¨ˆç®—æ•£è£çš„é‡‘é¡
                    return { packages, loose, looseAmount };
                }

                // --- äº‹ä»¶è™•ç†å‡½æ•¸ ---

                /**
                 * æ¸…é™¤æ‰€æœ‰è¼¸å…¥å’Œçµæœ
                 */
                function clearAll() {
                    // æ¸…é™¤ä¸»è¼¸å…¥æ¡†
                    Object.values(amountInputs).forEach(input => {
                        input.value = '';
                        input.classList.remove('input-error');
                        const errorMsg = document.getElementById(`error${input.dataset.denomination}`);
                        if (errorMsg) errorMsg.classList.remove('active');
                    });
                    Object.values(bagInputs).forEach(input => input.value = '');

                    // æ¸…é™¤é¡å¤–è¨ˆç®—å€å¡Š
                    extraCalcInputs.forEach(input => input.value = '');
                    updateExtraCalc(); // æ›´æ–°é¡¯ç¤ºç‚º 0

                    // éš±è—çµæœå€å¡Š
                    if (resultContainer) resultContainer.classList.remove('active');

                    // é‡ç½®éŒ¯èª¤æç¤º
                    const pettyCashBox = document.getElementById('petty-cash-box');
                    if (pettyCashBox) pettyCashBox.classList.remove('error');
                    const balanceWarning = document.getElementById('balance-warning');
                    if (balanceWarning) balanceWarning.style.display = 'none';
                }

                /**
                 * å¡«å…¥æ¨¡æ“¬æ•¸å€¼
                 */
                function simulateValues() {
                    clearAll(); // æ¸…é™¤èˆŠå€¼
                    amountInputs['1000'].value = formatNumber('16000'); // ä½¿ç”¨formatNumberç¢ºä¿æ ¼å¼ä¸€è‡´
                    amountInputs['500'].value = formatNumber('17000');
                    amountInputs['100'].value = formatNumber('6100');
                    amountInputs['50'].value = formatNumber('1400');
                    amountInputs['10'].value = formatNumber('910');
                    amountInputs['5'].value = formatNumber('410');
                    amountInputs['1'].value = formatNumber('51');

                    // æ¨¡æ“¬è¢‹/æ†æ•¸ (å¯é¸ï¼Œè‹¥è¦æ¸¬è©¦ç›¸é—œé‚è¼¯å¯å–æ¶ˆè¨»è§£)
                    // bagInputs['100'].value = '1'; // 1æ†100å…ƒ = 2000
                    if(bagInputs['50']) bagInputs['50'].value = '1'; // 1è¢‹50å…ƒ = 2000
                    // bagInputs['10'].value = '1'; // 1è¢‹10å…ƒ = 500
                    // bagInputs['5'].value = '1'; // 1è¢‹5å…ƒ = 250
                    if(bagInputs['1']) bagInputs['1'].value = '1'; // 1è¢‹1å…ƒ = 100
                }

                /**
                 * ä¸»è¨ˆç®—æµç¨‹
                 */
                function calculate() {
                     // 1. é©—è­‰è¼¸å…¥ä¸¦ç²å–å„é¢é¡é‡‘é¡èˆ‡æ•¸é‡
                    let hasError = false;
                    let currentAmounts = {}; // å„²å­˜ç•¶å‰å„é¢é¡çš„ç¸½é‡‘é¡ (åŒ…å«è¢‹/æ†)
                    let currentCounts = {}; // å„²å­˜ç•¶å‰å„é¢é¡çš„ç¸½å¼µ/æšæ•¸

                    denominations.forEach(denom => {
                        const input = amountInputs[denom];
                        const bagInput = bagInputs[denom];
                        const errorElement = document.getElementById(`error${denom}`);
                        let totalAmountForDenom = parseInputValue(input.value); // è§£æé‡‘é¡è¼¸å…¥æ¡†

                        // æ¸…é™¤èˆŠéŒ¯èª¤æ¨£å¼èˆ‡è¨Šæ¯
                        input.classList.remove('input-error');
                        if (errorElement) errorElement.classList.remove('active');

                        // åŠ ä¸Šè¢‹/æ†çš„é‡‘é¡
                        if (bagInput && bagInput.value) {
                            const packages = parseInt(bagInput.value, 10) || 0;
                            if (packages > 0) {
                                const packageType = bagInput.dataset.packageType; // 'bag' æˆ– 'bundle'
                                const packageKey = `${packageType}${denom}`;
                                if (packagingRules[packageKey]) {
                                    totalAmountForDenom += packages * packagingRules[packageKey].value;
                                }
                            }
                        }

                        // é©—è­‰ç¸½é‡‘é¡æ˜¯å¦ç‚ºé¢é¡çš„å€æ•¸
                        if (totalAmountForDenom % denom !== 0) {
                            input.classList.add('input-error');
                            if (errorElement) {
                                errorElement.textContent = `è«‹è¼¸å…¥${denom}çš„å€æ•¸`; // æ›´æ–°éŒ¯èª¤è¨Šæ¯
                                errorElement.classList.add('active');
                            }
                            hasError = true;
                        }

                        currentAmounts[denom] = totalAmountForDenom;
                        currentCounts[denom] = Math.floor(totalAmountForDenom / denom); // è¨ˆç®—å¼µ/æšæ•¸
                    });

                    if (hasError) {
                        alert('éƒ¨åˆ†é‡‘é¡è¼¸å…¥éŒ¯èª¤ï¼Œè«‹æª¢æŸ¥ç´…è‰²æ¡†æ¨™ç¤ºçš„æ¬„ä½ï¼');
                        if (resultContainer) resultContainer.classList.remove('active'); // è‹¥æœ‰éŒ¯èª¤å‰‡éš±è—èˆŠçµæœ
                        return; // ä¸­æ–·è¨ˆç®—
                    }

                    // 2. è¨ˆç®—ç¸½é‡‘é¡
                    const totalAmount = Object.values(currentAmounts).reduce((sum, val) => sum + val, 0);

                    // 3. é›¶éŒ¢è™•ç†
                    const totalCoinsAmount = currentAmounts['50'] + currentAmounts['10'] + currentAmounts['5'] + currentAmounts['1']; // ç¡¬å¹£ç¸½é¡
                    const remainderCoinsAmount = totalCoinsAmount % 100; // ä¸è¶³ç™¾å…ƒçš„é›¶éŒ¢ (ç§»å…¥ç‡Ÿæ”¶)
                    const keptCoinsAmount = totalCoinsAmount - remainderCoinsAmount; // å¯æ¹Šæˆç™¾å…ƒçš„ç¡¬å¹£ç¸½é¡ (ç•™åœ¨é›¶ç”¨é‡‘)

                    // è¨ˆç®—ç§»å…¥ç‡Ÿæ”¶çš„é›¶éŒ¢æ˜ç´° (å¾ç¸½ç¡¬å¹£ä¸­å–å‡º remainderCoinsAmount çš„éƒ¨åˆ†)
                    const smallCoinsBreakdown = getCoinsBreakdown(remainderCoinsAmount, currentAmounts); // availableAmounts å‚³é currentAmounts

                    // 4. è¨ˆç®—é ç•™é›¶ç”¨é‡‘ (ç›®æ¨™ 20,000)
                    const pettyCashTarget = 20000;
                    // éœ€è¦ç”¨ç´™éˆ”è£œè¶³çš„é‡‘é¡ = ç›®æ¨™ - ä¿ç•™çš„ç¡¬å¹£é‡‘é¡
                    const remainingCashNeededForPettyCash = pettyCashTarget - keptCoinsAmount;

                    let actualPettyCash = 0; // å¯¦éš›é ç•™çš„é›¶ç”¨é‡‘ç¸½é¡
                    let balanceGap = 0;      // èˆ‡ç›®æ¨™çš„å·®é¡
                    let used100ForPettyCash = 0; // é›¶ç”¨é‡‘ä¸­ä½¿ç”¨çš„100å…ƒå¼µæ•¸
                    let used500ForPettyCash = 0; // é›¶ç”¨é‡‘ä¸­ä½¿ç”¨çš„500å…ƒå¼µæ•¸
                    let pettyCashPaperAmount = 0; // é›¶ç”¨é‡‘ä¸­çš„ç´™éˆ”ç¸½é¡

                    // è¨ˆç®—é ç•™é›¶ç”¨é‡‘ä¸­ä¿ç•™çš„ç¡¬å¹£æ˜ç´° (ç¸½ç¡¬å¹£æ•¸ - ç§»å…¥ç‡Ÿæ”¶çš„ç¡¬å¹£æ•¸)
                    const keptCoinsDetailCounts = {
                        '50': currentCounts['50'] - smallCoinsBreakdown['50'],
                        '10': currentCounts['10'] - smallCoinsBreakdown['10'],
                        '5': currentCounts['5'] - smallCoinsBreakdown['5'],
                        '1': currentCounts['1'] - smallCoinsBreakdown['1']
                    };

                    // è¨ˆç®—ä¿ç•™ç¡¬å¹£çš„è¢‹è£æƒ…æ³
                    const keptCoinsPackages = {};
                    [50, 10, 5, 1].forEach(denom => {
                        keptCoinsPackages[denom] = calculatePackages(keptCoinsDetailCounts[denom], denom);
                    });

                    // åˆ¤æ–·æ˜¯å¦éœ€è¦ç”¨ç´™éˆ”è£œè¶³é›¶ç”¨é‡‘
                    if (remainingCashNeededForPettyCash > 0) {
                        // ä½¿ç”¨åå‘è¿­ä»£æ³•æ‰¾å‡ºæœ€ä½³çµ„åˆ (å„ªå…ˆç”¨100å…ƒæ¹Š)
                        const optimalCombination = findOptimalCombination(
                            remainingCashNeededForPettyCash,
                            currentCounts['100'], // å¯ç”¨çš„100å…ƒç¸½å¼µæ•¸
                            currentCounts['500']  // å¯ç”¨çš„500å…ƒç¸½å¼µæ•¸
                        );

                        if (optimalCombination.found) {
                            // æ‰¾åˆ°äº†å‰›å¥½çš„çµ„åˆ
                            used100ForPettyCash = optimalCombination.used100;
                            used500ForPettyCash = optimalCombination.used500;
                            pettyCashPaperAmount = optimalCombination.amount100 + optimalCombination.amount500;
                            actualPettyCash = keptCoinsAmount + pettyCashPaperAmount;
                            balanceGap = 0; // å‰›å¥½é”åˆ°ç›®æ¨™
                        } else {
                             // æ‰¾ä¸åˆ°å‰›å¥½çš„çµ„åˆï¼Œç›¡é‡æ¹Š (å„ªå…ˆç”¨å¤§é¢é¡)
                            // å…ˆç”¨ 500 å…ƒ
                            const max500CountToUse = Math.min(
                                Math.floor(remainingCashNeededForPettyCash / 500),
                                currentCounts['500'] // ä¸èƒ½è¶…éç¾æœ‰çš„500å…ƒå¼µæ•¸
                            );
                            used500ForPettyCash = max500CountToUse;
                            const amountFrom500 = max500CountToUse * 500;

                            // å†ç”¨ 100 å…ƒè£œè¶³å‰©é¤˜
                            const stillNeededFor100 = remainingCashNeededForPettyCash - amountFrom500;
                            const max100CountToUse = Math.min(
                                Math.floor(stillNeededFor100 / 100), // æœ€å¤šéœ€è¦å¤šå°‘å¼µ100
                                currentCounts['100'] // ä¸èƒ½è¶…éç¾æœ‰çš„100å…ƒå¼µæ•¸
                            );
                            used100ForPettyCash = max100CountToUse;
                            const amountFrom100 = max100CountToUse * 100;

                            pettyCashPaperAmount = amountFrom500 + amountFrom100;
                            actualPettyCash = keptCoinsAmount + pettyCashPaperAmount;
                            balanceGap = pettyCashTarget - actualPettyCash; // è¨ˆç®—å·®é¡
                        }
                    } else {
                        // ä¸éœ€è¦ç´™éˆ”ï¼Œæˆ–ç¡¬å¹£å·²è¶…éç›®æ¨™
                        actualPettyCash = keptCoinsAmount; // é›¶ç”¨é‡‘å°±æ˜¯ä¿ç•™çš„ç¡¬å¹£ (å¯èƒ½å¤§æ–¼æˆ–ç­‰æ–¼ç›®æ¨™)
                        balanceGap = pettyCashTarget - actualPettyCash; // å¯èƒ½ç‚ºè² æ•¸æˆ–é›¶
                    }

                    // 5. è¨ˆç®—ç‡Ÿæ”¶ä¸Šç¹³
                    const revenueAmount = totalAmount - actualPettyCash;

                    // è¨ˆç®—å„é¢é¡åœ¨ç‡Ÿæ”¶ä¸Šç¹³ä¸­çš„æ•¸é‡
                    const revenueDetailCounts = {
                        '1000': currentCounts['1000'], // 1000å…ƒè‹¥æœ‰ï¼Œå…¨éƒ¨ä¸Šç¹³ (æ­¤è™•å‡è¨­1000å…ƒä¸åƒèˆ‡é›¶ç”¨é‡‘)
                        '500': currentCounts['500'] - used500ForPettyCash,
                        '100': currentCounts['100'] - used100ForPettyCash,
                        '50': smallCoinsBreakdown['50'], // ç§»å…¥ç‡Ÿæ”¶çš„é›¶éŒ¢éƒ¨åˆ†
                        '10': smallCoinsBreakdown['10'],
                        '5': smallCoinsBreakdown['5'],
                        '1': smallCoinsBreakdown['1']
                    };
                     // è¨ˆç®—ç‡Ÿæ”¶ä¸Šç¹³çš„è¢‹/æ†æ•¸
                    const revenuePackages = {};
                     [100, 50, 10, 5, 1].forEach(denom => { // å‡è¨­1000å…ƒä¸æ‰“åŒ…
                        revenuePackages[denom] = calculatePackages(revenueDetailCounts[denom], denom);
                    });

                    // é›¶éŒ¢æ‰“åŒ…å€å¡Šé¡¯ç¤ºçš„æ˜¯é ç•™é›¶ç”¨é‡‘ä¸­ï¼Œæœªè¢«æ‰“åŒ…çš„æ•£å¹£ (å³ keptCoinsPackages ä¸­çš„ loose éƒ¨åˆ†)
                    const coinPackAmounts = {}; // ç”¨æ–¼é›¶éŒ¢æ‰“åŒ…å€å¡Šé¡¯ç¤ºçš„ã€Œé‡‘é¡ã€
                    [50,10,5,1].forEach(denom => {
                        coinPackAmounts[denom] = keptCoinsPackages[denom].looseAmount;
                    });


                    // 6. æ›´æ–° UI é¡¯ç¤º
                    updateUI(totalAmount, remainderCoinsAmount, totalCoinsAmount, keptCoinsAmount, actualPettyCash, revenueAmount, balanceGap, smallCoinsBreakdown, keptCoinsDetailCounts, keptCoinsPackages, used100ForPettyCash, used500ForPettyCash, pettyCashPaperAmount, remainingCashNeededForPettyCash, revenueDetailCounts, revenuePackages, coinPackAmounts);

                    // é¡¯ç¤ºçµæœå€åŸŸ
                    if (resultContainer) resultContainer.classList.add('active');
                }

                /**
                 * æ›´æ–° UI é¡¯ç¤ºè¨ˆç®—çµæœ
                 * @param {number} totalAmount å…¨éƒ¨ç¸½é‡‘é¡
                 * @param {number} remainderCoinsAmount ç§»å…¥ç‡Ÿæ”¶çš„é›¶éŒ¢é‡‘é¡ (ä¸è¶³ç™¾çš„å°¾æ•¸)
                 * @param {number} totalCoinsAmount ç¡¬å¹£ç¸½é‡‘é¡ (50+10+5+1)
                 * @param {number} keptCoinsAmount é ç•™é›¶ç”¨é‡‘ä¸­ä¿ç•™çš„ç¡¬å¹£ç¸½é¡ (æ¹Šç™¾çš„éƒ¨åˆ†)
                 * @param {number} actualPettyCash å¯¦éš›é ç•™çš„é›¶ç”¨é‡‘ç¸½é¡
                 * @param {number} revenueAmount ç‡Ÿæ”¶ä¸Šç¹³ç¸½é¡
                 * @param {number} balanceGap é ç•™é›¶ç”¨é‡‘èˆ‡ç›®æ¨™çš„å·®é¡
                 * @param {object} smallCoinsBreakdown ç§»å…¥ç‡Ÿæ”¶çš„é›¶éŒ¢å„é¢é¡æšæ•¸
                 * @param {object} keptCoinsDetailCounts é ç•™é›¶ç”¨é‡‘ä¸­å„ç¡¬å¹£é¢é¡æšæ•¸
                 * @param {object} keptCoinsPackages é ç•™é›¶ç”¨é‡‘ä¸­å„ç¡¬å¹£çš„æ‰“åŒ…è³‡è¨Š
                 * @param {number} used100ForPettyCash é›¶ç”¨é‡‘ä¸­ä½¿ç”¨çš„100å…ƒå¼µæ•¸
                 * @param {number} used500ForPettyCash é›¶ç”¨é‡‘ä¸­ä½¿ç”¨çš„500å…ƒå¼µæ•¸
                 * @param {number} pettyCashPaperAmount é›¶ç”¨é‡‘ä¸­çš„ç´™éˆ”ç¸½é¡
                 * @param {number} remainingCashNeededForPettyCash é›¶ç”¨é‡‘ç›®æ¨™å°šéœ€ç´™éˆ”è£œè¶³çš„é‡‘é¡
                 * @param {object} revenueDetailCounts ç‡Ÿæ”¶ä¸Šç¹³ä¸­å„é¢é¡çš„å¼µ/æšæ•¸
                 * @param {object} revenuePackages ç‡Ÿæ”¶ä¸Šç¹³ä¸­å„é¢é¡çš„æ‰“åŒ…è³‡è¨Š
                 * @param {object} coinPackAmounts é›¶éŒ¢æ‰“åŒ…å€å¡Šå„é¢é¡çš„æ•£å¹£é‡‘é¡ (ä¾†è‡ªé ç•™é›¶ç”¨é‡‘)
                 */
                function updateUI(totalAmount, remainderCoinsAmount, totalCoinsAmount, keptCoinsAmount, actualPettyCash, revenueAmount, balanceGap, smallCoinsBreakdown, keptCoinsDetailCounts, keptCoinsPackages, used100ForPettyCash, used500ForPettyCash, pettyCashPaperAmount, remainingCashNeededForPettyCash, revenueDetailCounts, revenuePackages, coinPackAmounts) {
                    // --- çµæœç¸½è¦½ --- (Summary Section)
                    const totalAmountEl = document.getElementById('total-amount');
                    if (totalAmountEl) totalAmountEl.textContent = formatMoney(totalAmount);

                    const summarySmallCoinsEl = document.getElementById('summary-small-coins');
                    if (summarySmallCoinsEl) summarySmallCoinsEl.textContent = formatMoney(remainderCoinsAmount);

                    const summaryRevenueEl = document.getElementById('summary-revenue');
                    if (summaryRevenueEl) summaryRevenueEl.textContent = formatMoney(revenueAmount);

                    const pettyCashActualEl = document.getElementById('petty-cash-actual');
                    if (pettyCashActualEl) pettyCashActualEl.textContent = formatMoney(actualPettyCash);

                    // é ç•™é›¶ç”¨é‡‘ç›®æ¨™é”æˆç‹€æ…‹ (æ ¹æ“šå·®é¡æ›´æ–°æ¨£å¼)
                    const pettyBoxElement = document.getElementById('petty-cash-box');
                    if (pettyBoxElement) pettyBoxElement.classList.toggle('error', balanceGap !== 0);

                    // --- ç‡Ÿæ”¶ä¸Šç¹³ --- (Revenue Deposit Section)
                    const revenueAmountElement = document.getElementById('revenue-amount');
                    if (revenueAmountElement) revenueAmountElement.textContent = formatMoney(revenueAmount);

                    let revenueNotesHTML = '<ul class="item-list">'; // åˆå§‹åŒ–ç´™éˆ”åˆ—è¡¨HTML
                    let revenueCoinsHTML = '<ul class="item-list">'; // åˆå§‹åŒ–ç¡¬å¹£åˆ—è¡¨HTML
                    const revenueDenominations = [1000, 500, 100, 50, 10, 5, 1]; // ä¸Šç¹³é¢é¡é †åº

                    revenueDenominations.forEach(denom => {
                        const count = revenueDetailCounts[denom]; // å–å¾—è©²é¢é¡ä¸Šç¹³çš„å¼µ/æšæ•¸
                        if (count > 0) { // åªè™•ç†æ•¸é‡å¤§æ–¼0çš„é¢é¡
                            const amount = count * denom;
                            let packageText = ''; // æ‰“åŒ…è³‡è¨Šæ–‡å­—

                            if (denom === 1000 || denom === 500) {
                                packageText = `${count} å¼µ`;
                            } else if (denom === 100) {
                                const packageInfo = revenuePackages[denom];
                                if (packageInfo.packages > 0) {
                                    packageText += `${packageInfo.packages}æ†`;
                                    if (packageInfo.loose > 0) {
                                        packageText += ` + ${packageInfo.loose}å¼µ`;
                                    }
                                } else {
                                    packageText = `${count}å¼µ`;
                                }
                            } else { // ç¡¬å¹£é¡¯ç¤ºæšæ•¸å’Œè¢‹æ•¸
                                const packageInfo = revenuePackages[denom];
                                if (packageInfo.packages > 0) {
                                    packageText += `${packageInfo.packages}è¢‹`;
                                    if (packageInfo.loose > 0) {
                                        packageText += ` + ${packageInfo.loose}æš`;
                                    }
                                } else {
                                    packageText = `${count}æš`;
                                }
                            }

                            const rowHTML = `
                                <li class="item">
                                    <div class="denom-icon d${denom}">${denom}</div>
                                    <div class="amount money-amount-${denom}">${formatMoney(amount)}</div>
                                    <div class="meta">${packageText}</div>
                                </li>
                            `;
                            if (denom >= 100) { // ç´™éˆ”
                                revenueNotesHTML += rowHTML;
                            } else { // ç¡¬å¹£
                                revenueCoinsHTML += rowHTML;
                            }
                        }
                    });

                    revenueNotesHTML += '</ul>'; // çµæŸç´™éˆ”åˆ—è¡¨HTML
                    revenueCoinsHTML += '</ul>'; // çµæŸç¡¬å¹£åˆ—è¡¨HTML

                    const revenueNotesEl = document.getElementById('revenue-notes');
                    if (revenueNotesEl) revenueNotesEl.innerHTML = revenueNotesHTML.includes('<li') ? revenueNotesHTML : '<ul class="item-list"><li class="item">ç„¡ç´™éˆ”éœ€ä¸Šç¹³</li></ul>';
                    
                    const revenueCoinsEl = document.getElementById('revenue-coins');
                    if (revenueCoinsEl) revenueCoinsEl.innerHTML = revenueCoinsHTML.includes('<li') ? revenueCoinsHTML : '<ul class="item-list"><li class="item">ç„¡ç¡¬å¹£éœ€ä¸Šç¹³</li></ul>';


                    // --- é ç•™é›¶ç”¨é‡‘ --- (Petty Cash Section)
                    // 1. ç´™éˆ”å¡«æ»¿
                    let paperMoneyHTML = '<ul class="item-list">'; // åˆå§‹åŒ–ç´™éˆ”åˆ—è¡¨HTML
                     const paperDenominationsForPettyCash = [500, 100]; // é›¶ç”¨é‡‘ä¸­ç´™éˆ”é¢é¡é †åº
                     const paperCountsForPettyCash = { '500': used500ForPettyCash, '100': used100ForPettyCash }; // é›¶ç”¨é‡‘ä¸­å„ç´™éˆ”å¼µæ•¸

                     paperDenominationsForPettyCash.forEach(denom => {
                         const count = paperCountsForPettyCash[denom];
                         if (count > 0) { // åªè™•ç†æ•¸é‡å¤§æ–¼0çš„é¢é¡
                            const amount = count * denom;
                            let packageText = '';

                            if (denom === 500) {
                                packageText = `${count} å¼µ`;
                            } else if (denom === 100) {
                                const bundles = calculatePackages(count, 100); // 100å…ƒå¯èƒ½æœ‰æ†è£
                                if (bundles.packages > 0) {
                                    packageText = `${bundles.packages}æ†`;
                                    if (bundles.loose > 0) {
                                        packageText += ` + ${bundles.loose}å¼µ`;
                                    }
                                } else {
                                    packageText = `${count}å¼µ`;
                                }
                            }

                            paperMoneyHTML += `
                                <li class="item">
                                    <div class="denom-icon d${denom}">${denom}</div>
                                    <div class="amount money-amount-${denom}">${formatMoney(amount)}</div>
                                    <div class="meta">${packageText}</div>
                                </li>
                            `;
                        }
                     });
                    paperMoneyHTML += '</ul>'; // çµæŸç´™éˆ”åˆ—è¡¨HTML

                    const paperMoneyDetailEl = document.getElementById('paper-money-detail');
                    if (paperMoneyDetailEl) paperMoneyDetailEl.innerHTML = paperMoneyHTML.includes('<li') ? paperMoneyHTML : '<ul class="item-list"><li class="item">ç„¡ç´™éˆ”</li></ul>';
                    
                    // ä»¥ä¸‹ID 'notes-total', 'target-gap', 'kept-coins-total', 'coins-total' åœ¨HTMLä¸­ä¼¼ä¹ä¸å­˜åœ¨æˆ–å‘½åä¸åŒï¼Œè‹¥è¦ä½¿ç”¨éœ€ç¢ºèªHTMLçµæ§‹
                    // const notesTotalEl = document.getElementById('notes-total'); // HTML ä¸­æ­¤IDä¸å­˜åœ¨
                    // if (notesTotalEl) notesTotalEl.textContent = formatMoney(pettyCashPaperAmount);
                    // 
                    // const targetGapEl = document.getElementById('target-gap'); // HTML ä¸­æ­¤IDä¸å­˜åœ¨
                    // if (targetGapEl) targetGapEl.textContent = formatMoney(remainingCashNeededForPettyCash);

                    // 2. ä¿ç•™ç¡¬å¹£
                    // const keptCoinsTotalEl = document.getElementById('kept-coins-total'); // HTML ä¸­æ­¤IDä¸å­˜åœ¨
                    // if (keptCoinsTotalEl) keptCoinsTotalEl.textContent = formatMoney(keptCoinsAmount);
                    
                    let keptCoinsHTML = '<ul class="item-list">'; // åˆå§‹åŒ–ä¿ç•™ç¡¬å¹£åˆ—è¡¨HTML
                    [50, 10, 5, 1].forEach(denom => {
                        const count = keptCoinsDetailCounts[denom]; // å–å¾—è©²é¢é¡åœ¨é›¶ç”¨é‡‘ä¸­çš„æšæ•¸
                        const amount = count * denom;
                        const packageInfo = keptCoinsPackages[denom]; // è©²é¢é¡åœ¨é›¶ç”¨é‡‘ä¸­çš„æ‰“åŒ…è³‡è¨Š
                        let packageText = ''; 

                        if (packageInfo.packages > 0) {
                            packageText += `${packageInfo.packages}è¢‹`; // ç¡¬å¹£éƒ½æ˜¯è¢‹è£
                            if (packageInfo.loose > 0) { 
                                packageText += ` + ${packageInfo.loose}æš`;
                            }
                        } else if (packageInfo.loose > 0) { 
                            packageText = `${packageInfo.loose}æš`;
                        } else if (count === 0) { 
                            packageText = '0æš';
                        }
                        
                        if (!packageText && count > 0) {
                            packageText = `${count}æš`;
                        }

                        keptCoinsHTML += `
                            <li class="item">
                                <div class="denom-icon d${denom}">${denom}</div>
                                <div class="amount money-amount-${denom}">${formatMoney(amount)}</div>
                                <div class="meta">${packageText || (count > 0 ? (count + 'æš') : '0æš')}</div>
                            </li>
                        `;
                    });
                    keptCoinsHTML += '</ul>'; // çµæŸä¿ç•™ç¡¬å¹£åˆ—è¡¨HTML
                    const keptCoinsDetailEl = document.getElementById('kept-coins-detail');
                    if (keptCoinsDetailEl) keptCoinsDetailEl.innerHTML = keptCoinsHTML;
                    
                    // const coinsTotalEl = document.getElementById('coins-total'); // HTMLä¸­ 'total-coins' ç”¨æ–¼é›¶éŒ¢è™•ç†å€å¡Šçš„åˆè¨ˆï¼Œè€Œéé ç•™é›¶ç”¨é‡‘çš„ç¡¬å¹£åˆè¨ˆ
                    // if (coinsTotalEl) coinsTotalEl.textContent = formatMoney(keptCoinsAmount);


                    // é ç•™é›¶ç”¨é‡‘ç¸½è¨ˆ
                    const pettyCashFinalEl = document.getElementById('petty-cash-final');
                    if (pettyCashFinalEl) pettyCashFinalEl.textContent = formatMoney(actualPettyCash);

                    // é ç•™é›¶ç”¨é‡‘å·®é¡è­¦å‘Š
                    const balanceWarningElement = document.getElementById('balance-warning');
                    const balanceWarningTextElement = document.getElementById('balance-warning-text');
                    if (balanceWarningElement && balanceWarningTextElement) { // ç¢ºä¿å…©å€‹å…ƒç´ éƒ½å­˜åœ¨
                        if (balanceGap !== 0) {
                            balanceWarningElement.style.display = 'block';
                            let warningText = `<p>é ç•™é›¶ç”¨é‡‘å¯¦éš›ç‚º <strong>${formatMoney(actualPettyCash)}</strong>ï¼Œ`;
                            if (balanceGap > 0) { // å°‘äº†
                                warningText += `æ¯”ç›®æ¨™é‡‘é¡å°‘äº† <strong>${formatMoney(balanceGap)}</strong>ã€‚</p>`;
                                warningText += `<p>åŸå› ï¼šå¯ç”¨çš„ 100 å…ƒæˆ– 500 å…ƒç´™éˆ”ä¸è¶³ä»¥è£œè¶³å·®é¡ã€‚</p>`;
                                warningText += `<p>å»ºè­°ï¼šæª¢æŸ¥è¼¸å…¥çš„ç´™éˆ”é‡‘é¡æ˜¯å¦æ­£ç¢ºï¼Œæˆ–èª¿æ•´ç¾é‡‘çµæ§‹ã€‚</p>`;
                            } else { // å¤šäº† (ç¡¬å¹£è¶…éç›®æ¨™æ™‚)
                                warningText += `æ¯”ç›®æ¨™é‡‘é¡å¤šäº† <strong>${formatMoney(Math.abs(balanceGap))}</strong>ã€‚</p>`;
                                warningText += `<p>åŸå› ï¼šä¿ç•™çš„ç¡¬å¹£é‡‘é¡å·²è¶…é ${formatMoney(pettyCashTarget)}ã€‚</p>`; // é¡¯ç¤ºç›®æ¨™é‡‘é¡
                                warningText += `<p>å»ºè­°ï¼šå°‡éƒ¨åˆ†ç¡¬å¹£æ›æˆç´™éˆ”ï¼Œæˆ–ç¢ºèªè¨ˆç®—è¦å‰‡ã€‚</p>`;
                            }
                            balanceWarningTextElement.innerHTML = warningText;
                        } else {
                            balanceWarningElement.style.display = 'none';
                        }
                    }

                    // --- é›¶éŒ¢è™•ç† â†’ ç§»å…¥ç‡Ÿæ”¶ (å·²æŠ˜ç–Š) --- (Small Coins Handling Section)
                    const totalCoinsEl = document.getElementById('total-coins'); // æ­¤ç‚ºé›¶éŒ¢è™•ç†å€å¡Šçš„ç¡¬å¹£åˆè¨ˆ
                    if (totalCoinsEl) totalCoinsEl.textContent = formatMoney(totalCoinsAmount);
                    
                    const remainderCoinsEl = document.getElementById('remainder-coins');
                    if (remainderCoinsEl) remainderCoinsEl.textContent = formatMoney(remainderCoinsAmount);
                    
                    const movedCoinsEl = document.getElementById('moved-coins');
                    if (movedCoinsEl) movedCoinsEl.textContent = formatMoney(remainderCoinsAmount);

                    // ç§»å…¥ç‡Ÿæ”¶çš„é›¶éŒ¢æ˜ç´°
                    let coinBreakdownHTML = '';
                    if (remainderCoinsAmount > 0) {
                        const parts = [];
                        [50, 10, 5, 1].forEach(denom => {
                            if (smallCoinsBreakdown[denom] > 0) {
                                parts.push(`<span class="denom-icon denom-icon-small-breakdown d${denom}">${denom}</span> x ${smallCoinsBreakdown[denom]}`);
                            }
                        });
                        coinBreakdownHTML = `<div class="highlight" style="text-align:center; padding: 10px;">${formatMoney(remainderCoinsAmount)} = ${parts.join(' + ')}</div>`;
                    } else {
                        coinBreakdownHTML = '<div class="highlight" style="text-align:center; padding: 10px;">ç„¡é›¶éŒ¢ç§»å…¥ç‡Ÿæ”¶</div>';
                    }
                    const coinBreakdownEl = document.getElementById('coin-breakdown');
                    if (coinBreakdownEl) coinBreakdownEl.innerHTML = coinBreakdownHTML;


                    // --- é›¶éŒ¢æ‰“åŒ… --- (Coin Packing Section)
                    // æ­¤å€å¡Šé¡¯ç¤ºçš„æ˜¯é ç•™é›¶ç”¨é‡‘ä¸­ï¼Œæœªè¢«æ‰“åŒ…çš„ã€Œæ•£å¹£ã€çš„ã€Œé‡‘é¡ã€å’Œã€Œæšæ•¸ã€
                    let coinPackHTML = '<ul class="item-list">';
                    [50, 10, 5, 1].forEach(denom => {
                        const looseCoinAmountForPacking = coinPackAmounts[denom]; // é€™æ˜¯è©²é¢é¡åœ¨é›¶ç”¨é‡‘ä¸­æ•£å¹£çš„ã€Œé‡‘é¡ã€
                        const looseCoinCountForPacking = Math.floor(looseCoinAmountForPacking / denom); // æ•£å¹£çš„ã€Œæšæ•¸ã€
                        
                        // åªæœ‰ç•¶æœ‰æ•£å¹£æ™‚æ‰é¡¯ç¤ºè©²é¢é¡
                        // æˆ–è€…ï¼Œå³ä½¿æ˜¯0ï¼Œä¹Ÿç‚ºç‰¹å®šé¢é¡é¡¯ç¤º (å¦‚æœè¨­è¨ˆéœ€è¦ç¸½æ˜¯é¡¯ç¤ºæ‰€æœ‰ç¡¬å¹£é¢é¡)
                        if (looseCoinCountForPacking > 0 || (looseCoinAmountForPacking === 0 && [50,10,5,1].includes(denom) )) { // å¦‚æœéœ€è¦ç¸½æ˜¯é¡¯ç¤º0æšçš„é …ç›®
                             coinPackHTML += `
                                <li class="item">
                                    <div class="denom-icon d${denom} denom-icon-large">${denom}</div>
                                    <div class="coin-pack-value-container">
                                        <span class="highlight-amount-pack">${formatNumber(looseCoinAmountForPacking)}</span>
                                        <span class="coin-pack-loose-count">(${looseCoinCountForPacking}æš)</span>
                                    </div>
                                </li>
                            `;
                        }
                    });
                    coinPackHTML += '</ul>';
                    const coinPackBlockEl = document.getElementById('coin-pack-block');
                    if (coinPackBlockEl) coinPackBlockEl.innerHTML = coinPackHTML.includes('<li') ? coinPackHTML : '<ul class="item-list"><li class="item">ç„¡æ•£è£ç¡¬å¹£</li></ul>';
                }


                // --- é¢é¡æ›ç®—åŠŸèƒ½ ---

                /**
                 * åˆå§‹åŒ–é¢é¡æ›ç®—æ¨¡æ…‹æ¡†ï¼Œè®€å–ç•¶å‰ä¸»é é¢æ•¸å€¼
                 */
                function initExchangeModal() {
                    exchangeAmountInput.value = ''; // æ¸…ç©ºè½‰æ›é‡‘é¡è¼¸å…¥

                    // ç¢ºä¿æ‰€æœ‰ä¸»é é¢è¼¸å…¥æ¡†éƒ½æœ‰å€¼ï¼ˆè‡³å°‘ç‚º '0' ä»¥ä¾¿è¨ˆç®—ï¼‰
                    Object.values(amountInputs).forEach(input => {
                        if (!input.value.trim()) {
                            input.value = '0'; // è‹¥ç‚ºç©ºï¼Œå‰‡è¨­ç‚º0ï¼Œé¿å…å¾ŒçºŒparseInputValueå‡ºéŒ¯
                            formatInputWithCommas(input); // é †ä¾¿æ ¼å¼åŒ–
                        }
                    });

                    updateExchangeInfo(); // æ ¹æ“šç•¶å‰é¸æ“‡çš„é¢é¡æ›´æ–°é¡¯ç¤ºè³‡è¨Š
                }

                /**
                 * æ›´æ–°é¢é¡æ›ç®—æ¨¡æ…‹æ¡†ä¸­çš„è³‡è¨Šé¡¯ç¤º
                 */
                function updateExchangeInfo() {
                    const exchangeAmount = parseInputValue(exchangeAmountInput.value);
                    const fromDenom = parseInt(exchangeFromSelect.value);
                    const toDenom = parseInt(exchangeToSelect.value);

                    if (isNaN(fromDenom) || isNaN(toDenom)) return; // é˜²æ­¢åˆå§‹åŒ–æ™‚æˆ–ç„¡æ•ˆé¸æ“‡æ™‚å‡ºéŒ¯

                    // ç²å–ç•¶å‰ä¸»é é¢çš„é‡‘é¡å’Œæ•¸é‡
                    const fromInput = amountInputs[fromDenom];
                    const toInput = amountInputs[toDenom];

                    // ç¢ºä¿è¼¸å…¥æ¡†å­˜åœ¨
                    if (!fromInput || !toInput) {
                        console.error('é¢é¡æ›ç®—ï¼šæ‰¾ä¸åˆ°å°æ‡‰çš„è¼¸å…¥æ¡†ã€‚');
                        return;
                    }

                    const fromCurrentAmount = parseInputValue(fromInput.value);
                    const toCurrentAmount = parseInputValue(toInput.value);
                    const fromCurrentCount = Math.floor(fromCurrentAmount / fromDenom);
                    const toCurrentCount = Math.floor(toCurrentAmount / toDenom);

                    // é¡¯ç¤ºç•¶å‰ç‹€æ…‹
                    if (fromCurrentAmountSpan) fromCurrentAmountSpan.textContent = formatNumber(fromCurrentAmount);
                    if (fromCurrentCountSpan) fromCurrentCountSpan.textContent = fromCurrentCount;
                    if (toCurrentAmountSpan) toCurrentAmountSpan.textContent = formatNumber(toCurrentAmount);
                    if (toCurrentCountSpan) toCurrentCountSpan.textContent = toCurrentCount;

                    // --- è¨ˆç®—é è¦½è½‰æ›çµæœ ---
                    let validExchangeAmount = 0;
                    let fromNewAmount = fromCurrentAmount;
                    let fromNewCount = fromCurrentCount;
                    let toNewAmount = toCurrentAmount;
                    let toNewCount = toCurrentCount;

                    if (exchangeAmount > 0 && fromDenom !== toDenom) {
                        // é©—è­‰è½‰æ›é‡‘é¡æ˜¯å¦ç‚ºè½‰å‡ºé¢é¡çš„å€æ•¸
                        if (exchangeAmount % fromDenom !== 0) {
                            // æ¸…ç©ºé è¦½æˆ–é¡¯ç¤ºéŒ¯èª¤æç¤º
                            if (fromNewAmountSpan) fromNewAmountSpan.textContent = '---';
                            if (fromNewCountSpan) fromNewCountSpan.textContent = '---';
                            if (toNewAmountSpan) toNewAmountSpan.textContent = '---';
                            if (toNewCountSpan) toNewCountSpan.textContent = '---';
                            return; // ä¸ç¹¼çºŒè¨ˆç®—é è¦½
                        }

                        // é©—è­‰è½‰æ›é‡‘é¡æ˜¯å¦è¶…éå¯ç”¨é¤˜é¡
                        if (exchangeAmount > fromCurrentAmount) {
                            // æ¸…ç©ºé è¦½æˆ–é¡¯ç¤ºéŒ¯èª¤æç¤º
                            if (fromNewAmountSpan) fromNewAmountSpan.textContent = '---';
                            if (fromNewCountSpan) fromNewCountSpan.textContent = '---';
                            if (toNewAmountSpan) toNewAmountSpan.textContent = '---';
                            if (toNewCountSpan) toNewCountSpan.textContent = '---';
                            return; // ä¸ç¹¼çºŒè¨ˆç®—é è¦½
                        }

                        validExchangeAmount = exchangeAmount; // é‡‘é¡æœ‰æ•ˆ

                        // è¨ˆç®—è½‰æ›å¾Œçµæœ
                        fromNewAmount = fromCurrentAmount - validExchangeAmount;
                        fromNewCount = Math.floor(fromNewAmount / fromDenom);
                        toNewAmount = toCurrentAmount + validExchangeAmount;
                        toNewCount = Math.floor(toNewAmount / toDenom);
                    }

                    // æ›´æ–°é è¦½é¡¯ç¤º
                    if (fromNewAmountSpan) fromNewAmountSpan.textContent = formatNumber(fromNewAmount);
                    if (fromNewCountSpan) fromNewCountSpan.textContent = fromNewCount;
                    if (toNewAmountSpan) toNewAmountSpan.textContent = formatNumber(toNewAmount);
                    if (toNewCountSpan) toNewCountSpan.textContent = toNewCount;
                }

                /**
                 * åŸ·è¡Œé¢é¡è½‰æ›ï¼Œæ›´æ–°ä¸»é é¢è¼¸å…¥æ¡†
                 */
                function performExchange() {
                    const exchangeAmount = parseInputValue(exchangeAmountInput.value);
                    const fromDenom = parseInt(exchangeFromSelect.value);
                    const toDenom = parseInt(exchangeToSelect.value);

                    if (exchangeAmount <= 0) {
                        alert('è«‹è¼¸å…¥è¦è½‰æ›çš„é‡‘é¡ï¼');
                        return;
                    }

                    if (isNaN(fromDenom) || isNaN(toDenom)) {
                        alert('è«‹é¸æ“‡æœ‰æ•ˆçš„è½‰å‡ºå’Œè½‰å…¥é¢é¡ï¼');
                        return;
                    }

                    if (fromDenom === toDenom) {
                        alert('è½‰å‡ºé¢é¡å’Œè½‰å…¥é¢é¡ä¸èƒ½ç›¸åŒï¼');
                        return;
                    }

                    // å†æ¬¡é©—è­‰é‡‘é¡
                    if (exchangeAmount % fromDenom !== 0) {
                        alert(`è½‰æ›é‡‘é¡ ${formatMoney(exchangeAmount)} å¿…é ˆæ˜¯ ${fromDenom} å…ƒçš„å€æ•¸ï¼`);
                        return;
                    }

                    const fromInput = amountInputs[fromDenom];
                    const toInput = amountInputs[toDenom];
                    // å†æ¬¡ç¢ºä¿è¼¸å…¥æ¡†å­˜åœ¨
                    if (!fromInput || !toInput) {
                        alert('éŒ¯èª¤ï¼šæ‰¾ä¸åˆ°å°æ‡‰çš„é¢é¡è¼¸å…¥æ¡†ï¼Œç„¡æ³•åŸ·è¡Œè½‰æ›ã€‚');
                        return;
                    }
                    const fromCurrentAmount = parseInputValue(fromInput.value);

                    if (exchangeAmount > fromCurrentAmount) {
                        alert(`è½‰æ›é‡‘é¡ ${formatMoney(exchangeAmount)} è¶…é ${fromDenom}å…ƒ å¯ç”¨é¤˜é¡ ${formatMoney(fromCurrentAmount)}`);
                        return;
                    }

                    // --- åŸ·è¡Œè½‰æ› ---
                    const toCurrentAmount = parseInputValue(toInput.value);

                    const fromNewAmount = fromCurrentAmount - exchangeAmount;
                    const toNewAmount = toCurrentAmount + exchangeAmount;

                    // æ›´æ–°ä¸»é é¢è¼¸å…¥æ¡†çš„å€¼
                    if (fromInput) fromInput.value = formatNumber(fromNewAmount); // ä½¿ç”¨ formatNumber æ·»åŠ åƒåˆ†ä½
                    if (toInput) toInput.value = formatNumber(toNewAmount);

                    // è§¸ç™¼ä¸»é é¢è¼¸å…¥æ¡†çš„ input äº‹ä»¶ï¼Œä»¥ä¾¿å¯èƒ½å­˜åœ¨çš„å…¶ä»–é‚è¼¯ï¼ˆä¾‹å¦‚è¢‹/æ†è¨ˆç®—ï¼‰èƒ½æ›´æ–°
                    if (fromInput) fromInput.dispatchEvent(new Event('input', { bubbles: true }));
                    if (toInput) toInput.dispatchEvent(new Event('input', { bubbles: true }));

                    // é—œé–‰æ¨¡æ…‹çª—
                    if (exchangeModal) exchangeModal.style.display = 'none';
                    alert('é¢é¡è½‰æ›æˆåŠŸï¼');
                }


                // --- é¡å¤–è¨ˆç®—å€å¡ŠåŠŸèƒ½ ---
                let isExtraCalcLocked = false; // é¡å¤–è¨ˆç®—å€å¡Šæ˜¯å¦é–å®š

                // åˆ‡æ›é¡å¤–è¨ˆç®—å€å¡Šçš„é–å®šç‹€æ…‹
                function toggleExtraCalcLock() {
                    isExtraCalcLocked = !isExtraCalcLocked;
                    if (lockBtn) {
                        lockBtn.textContent = isExtraCalcLocked ? 'ğŸ”’' : 'ğŸ”“';
                        lockBtn.classList.toggle('locked', isExtraCalcLocked);
                        lockBtn.title = isExtraCalcLocked ? 'é»æ“Šè§£é–è¼¸å…¥æ¡†' : 'é»æ“Šé–å®šè¼¸å…¥æ¡†';
                    }
                    extraCalcInputs.forEach(input => input.disabled = isExtraCalcLocked);
                    // å¦‚æœè§£é–ï¼Œç«‹å³æ›´æ–°ä¸€æ¬¡è¨ˆç®—çµæœ
                    if (!isExtraCalcLocked) {
                        updateExtraCalc();
                    }
                }

                // æ›´æ–°é¡å¤–è¨ˆç®—å€å¡Šçš„çµæœ
                function updateExtraCalc() {
                    if (isExtraCalcLocked) return; // é–å®šæ™‚ä¸è¨ˆç®—

                    const reportTotal = parseInputValue(reportTotalInput.value);
                    const collectAmount = parseInputValue(collectAmountInput.value);
                    const pcAmount = parseInputValue(pcAmountInput.value);
                    const diff = collectAmount - reportTotal - pcAmount; // ç¸½é‡‘é¡ - å ±è¡¨ç¸½é¡ - PCé‡‘é¡
                    if (extraCalcResult) extraCalcResult.textContent = 'è¨ˆç®—çµæœï¼š' + formatMoney(diff);
                }

                // --- äº‹ä»¶ç¶å®š ---

                // æ¸…é™¤æŒ‰éˆ•
                if (clearBtn) clearBtn.addEventListener('click', clearAll);

                // æ¨¡æ“¬æ•¸å€¼æŒ‰éˆ•
                if (simulateBtn) simulateBtn.addEventListener('click', simulateValues);

                // è¨ˆç®—æŒ‰éˆ•
                if (calculateBtn) calculateBtn.addEventListener('click', calculate);

                // æŠ˜ç–Šå€å¡Š (é€šç”¨è™•ç†)
                document.querySelectorAll('.collapsible-header').forEach(header => {
                    header.addEventListener('click', () => {
                        // åˆ‡æ› header æœ¬èº«çš„ collapsed class
                        header.classList.toggle('collapsed');

                        // æ‰¾åˆ°å°æ‡‰çš„å…§å®¹å€å¡Š ID: æŠŠ "Header" æ›æˆ "Content"
                        const contentId = header.id.replace('Header', 'Content');
                        const contentEl = document.getElementById(contentId);
                        if (contentEl) {
                            contentEl.classList.toggle('collapsed');
                        }
                    });
                });

                // é¡å¤–è¨ˆç®—å€å¡ŠæŠ˜ç–Šèˆ‡é–å®š
                if (extraCalcHeader) {
                    extraCalcHeader.addEventListener('click', (e) => {
                        // ç¢ºä¿é»æ“Šçš„ä¸æ˜¯é–å®šæŒ‰éˆ•æœ¬èº«
                        if (!e.target.closest('#lock-btn')) {
                            if (extraCalcContainer) extraCalcContainer.classList.toggle('collapsed');
                            if (extraCalcIcon) extraCalcIcon.classList.toggle('collapsed');
                        }
                    });
                }
                if (lockBtn) lockBtn.addEventListener('click', toggleExtraCalcLock);
                extraCalcInputs.forEach(input => {
                    input.addEventListener('input', () => {
                        formatInputWithCommas(input); // æ·»åŠ åƒåˆ†ä½
                        updateExtraCalc(); // å³æ™‚æ›´æ–°è¨ˆç®—çµæœ
                    });
                });


                // ä¸»é é¢é‡‘é¡è¼¸å…¥æ¡†äº‹ä»¶ (æ ¼å¼åŒ– + å¤±å»ç„¦é»æ™‚é©—è­‰)
                Object.values(amountInputs).forEach(input => {
                    const denomination = parseInt(input.dataset.denomination);

                    // å³æ™‚æ ¼å¼åŒ–åƒåˆ†ä½
                    input.addEventListener('input', function() {
                        formatInputWithCommas(this);
                    });

                    // å¤±å»ç„¦é»æ™‚é©—è­‰æ˜¯å¦ç‚ºé¢é¡å€æ•¸
                    input.addEventListener('blur', function() {
                        const value = parseInputValue(this.value);
                        const errorElement = document.getElementById(`error${denomination}`);

                        // å…ˆæ¸…é™¤ä¹‹å‰çš„éŒ¯èª¤ç‹€æ…‹
                        this.classList.remove('input-error');
                        if (errorElement) errorElement.classList.remove('active');

                        if (this.value.trim() === '') return; // ç©ºå€¼ä¸é©—è­‰ï¼Œç”±è¨ˆç®—æŒ‰éˆ•çµ±ä¸€è™•ç†

                        if (value % denomination !== 0) {
                            // è‡ªå‹•èª¿æ•´ç‚ºæœ€æ¥è¿‘çš„å€æ•¸ (å‘ä¸‹å–æ•´)
                            const adjustedValue = Math.floor(value / denomination) * denomination;
                            this.value = formatNumber(adjustedValue); // æ ¼å¼åŒ–å¾Œå¡«å›
                            
                            if (errorElement) {
                                errorElement.textContent = `å·²è‡ªå‹•èª¿æ•´ç‚º ${denomination} çš„å€æ•¸`;
                                errorElement.classList.add('active');
                                setTimeout(() => {
                                    if (errorElement.classList.contains('active')) { // å†æ¬¡æª¢æŸ¥æ˜¯å¦ä»ç‚º activeï¼Œé¿å…è¦†è“‹å¾ŒçºŒçš„éŒ¯èª¤è¨Šæ¯
                                        errorElement.classList.remove('active');
                                        errorElement.textContent = `è«‹è¼¸å…¥${denomination}çš„å€æ•¸`; // æ¢å¾©åŸå§‹æç¤º
                                    }
                                }, 2500); // å»¶é•·æç¤ºæ™‚é–“
                            }
                        }
                    });
                });

                // è¢‹/æ†è¼¸å…¥æ¡† (åªå…è¨±æ•¸å­—)
                Object.values(bagInputs).forEach(input => {
                    input.addEventListener('input', function() {
                        this.value = this.value.replace(/[^\d]/g, '');
                    });
                });

                // æ¨¡æ…‹æ¡†é–‹é—œ
                if (showPackageBtn) showPackageBtn.onclick = () => { if (packageModal) packageModal.style.display = "block"; };
                if (showManualBtn) showManualBtn.onclick = () => { if (manualModal) manualModal.style.display = "block"; };
                if (showExchangeBtn) {
                    showExchangeBtn.onclick = () => {
                        if (exchangeModal) {
                            initExchangeModal(); // åˆå§‹åŒ–é¢é¡æ›ç®—æ¨¡æ…‹æ¡†
                            exchangeModal.style.display = "block";
                        }
                    };
                }

                closeBtns.forEach(btn => {
                    btn.onclick = () => {
                        if (packageModal) packageModal.style.display = "none";
                        if (manualModal) manualModal.style.display = "none";
                        if (exchangeModal) exchangeModal.style.display = "none";
                        // ä¹Ÿé—œé–‰é¡è‰²è‡ªè¨‚ Modal (å¦‚æœå®ƒæ˜¯é€é .close æŒ‰éˆ•è§¸ç™¼)
                        if (colorModal && btn.closest('#color-modal')) toggleColorModal(false); // ä½¿ç”¨ toggleColorModal ä»¥ç¢ºä¿ç›¸é—œé‚è¼¯åŸ·è¡Œ
                    };
                });

                // é»æ“Šæ¨¡æ…‹æ¡†å¤–éƒ¨é—œé–‰
                window.onclick = (event) => {
                    if (event.target === packageModal) packageModal.style.display = "none";
                    if (event.target === manualModal) manualModal.style.display = "none";
                    if (event.target === exchangeModal) exchangeModal.style.display = "none";
                    if (event.target === colorModal) toggleColorModal(false); // ä½¿ç”¨ toggleColorModal ä»¥åŸ·è¡Œ initPickers
                };

                // é¢é¡æ›ç®—æ¨¡æ…‹æ¡†äº‹ä»¶
                if (exchangeAmountInput) {
                    exchangeAmountInput.addEventListener('input', () => {
                        formatInputWithCommas(exchangeAmountInput); // å³æ™‚æ ¼å¼åŒ–
                        updateExchangeInfo(); // æ›´æ–°é è¦½
                    });
                }
                if (exchangeFromSelect) exchangeFromSelect.addEventListener('change', updateExchangeInfo);
                if (exchangeToSelect) exchangeToSelect.addEventListener('change', updateExchangeInfo);
                if (exchangeConfirmBtn) exchangeConfirmBtn.addEventListener('click', performExchange); // ç¢ºèªè½‰æ›

                /* ===== é¢é¡é¡è‰²è‡ªè¨‚ ===== */
                const defaultColors = {
                    1000: '#3D93F0',
                    500:  '#C6A27B',
                    100:  '#DE4545',
                    50:   '#DAA520',
                    10:   '#453A3A',
                    5:    '#A3A3A3',
                    1:    '#790C0C'
                };
                const colorModal        = document.getElementById('color-modal');
                const customColorBtn    = document.getElementById('custom-color-btn');
                const closeColorBtn     = document.querySelector('#color-modal .close'); // ç‰¹å®šé¸å–é¡è‰²Modalçš„é—œé–‰æŒ‰éˆ•
                const finishColorBtn    = document.getElementById('close-color-modal');
                const resetColorBtn     = document.getElementById('reset-colors');

                /* æŠŠè‰²ç¥¨èˆ‡ hex æ¨™ç±¤çµ„æˆé™£åˆ—ï¼Œæ–¹ä¾¿è¿´åœˆ */
                const colorPickers = [1000,500,100,50,10,5,1].map(v => ({
                    denom: v,
                    picker: document.getElementById(`pick-${v}`),
                    hex:    document.getElementById(`hex-${v}`)
                }));

                /* é–‹å•Ÿ / é—œé–‰ Modal */
                if(customColorBtn) customColorBtn.onclick  = () => toggleColorModal(true);
                if(closeColorBtn) closeColorBtn.onclick   = () => toggleColorModal(false);
                if(finishColorBtn) finishColorBtn.onclick = () => toggleColorModal(false);
                // window.addEventListener('click', e => { if (e.target === colorModal) toggleColorModal(false); }); // å·²åœ¨ä¸Šæ–¹é€šç”¨window.onclickè™•ç†

                /**
                 * åˆ‡æ›é¡è‰²è‡ªè¨‚ Modal çš„é¡¯ç¤ºç‹€æ…‹ï¼Œä¸¦åœ¨é–‹å•Ÿæ™‚åˆå§‹åŒ–è‰²ç¥¨
                 * @param {boolean} show - true ç‚ºé¡¯ç¤º, false ç‚ºéš±è—
                 */
                function toggleColorModal(show){
                    if (colorModal) {
                        colorModal.style.display = show ? 'block' : 'none';
                        if(show) initPickers();
                    }
                }

                /* åˆå§‹åŒ–è‰²ç¥¨é¡è‰² & æ¨™ç±¤ (å¾ CSS è®Šæ•¸è®€å–) */
                function initPickers(){
                    colorPickers.forEach(({denom,picker,hex}) => {
                        if(picker && hex){ // ç¢ºä¿å…ƒç´ å­˜åœ¨
                            const cssVar = denom >= 100 ? `--note-${denom}` : `--coin-${denom}`;
                            const current = getComputedStyle(document.documentElement).getPropertyValue(cssVar).trim() || defaultColors[denom];
                            picker.value  = current;
                            hex.textContent = current.toUpperCase();
                        }
                    });
                }

                /* ç›£è½è®Šå‹•ï¼šç«‹åˆ»å¯«å…¥ CSS è®Šæ•¸ä¸¦æ›´æ–° hex æ¨™ç±¤ */
                colorPickers.forEach(({denom,picker,hex})=>{
                    if(picker){ // ç¢ºä¿å…ƒç´ å­˜åœ¨
                        picker.addEventListener('input',e=>{
                            applyColor(denom,e.target.value);
                            if(hex) hex.textContent = e.target.value.toUpperCase();
                        });
                    }
                });

                /* ä¸€éµé‚„åŸé è¨­é¡è‰² */
                if(resetColorBtn) resetColorBtn.onclick = () => {
                    Object.entries(defaultColors).forEach(([d,c]) => applyColor(parseInt(d),c)); // å­—ä¸²è½‰å›æ•¸å­—
                    initPickers(); /* æ›´æ–°è‰²ç¥¨é¡è‰²/æ–‡å­— */
                };

                /** 
                 * å°‡æŒ‡å®šé¡è‰²æ‡‰ç”¨åˆ° CSS è®Šæ•¸
                 * @param {number} denom - é¢é¡å€¼
                 * @param {string} color - é¡è‰²ç¢¼ (ä¾‹å¦‚ #RRGGBB)
                 */
                function applyColor(denom,color){
                    const varName = denom >= 100 ? `--note-${denom}` : `--coin-${denom}`;
                    document.documentElement.style.setProperty(varName,color);
                }

            });

            // åŒ¯å…¥å…¨éƒ¨ç¸½é‡‘é¡â†’ç¸½é‡‘é¡ (æ­¤å‡½æ•¸æ”¾åœ¨å…¨åŸŸï¼Œä»¥ä¾¿ onclick å‘¼å«)
            function importTotalAmount(){
                const totalEl=document.getElementById('total-amount');
                if(!totalEl)return;
                const num=parseInt(totalEl.textContent.replace(/[^0-9]/g,''))||0;
                const collectAmountInput = document.getElementById('collect-amount');
                if (collectAmountInput) {
                    collectAmountInput.value=num.toLocaleString('zh-TW'); // æ ¼å¼åŒ–å¾Œå¡«å…¥
                    collectAmountInput.dispatchEvent(new Event('input', { bubbles: true })); // è§¸ç™¼ input äº‹ä»¶ä»¥æ›´æ–°è¨ˆç®—
                }
            }

            // å·®å€¼å³æ™‚è¨ˆç®— (æ­¤å‡½æ•¸æ”¾åœ¨å…¨åŸŸï¼Œä¾›é¡å¤–è¨ˆç®—å€å¡Šçš„è¼¸å…¥æ¡†äº‹ä»¶ç›£è½å™¨å‘¼å«)
            // æ³¨æ„ï¼šæ­¤å‡½æ•¸å·²è¢«æ•´åˆåˆ° updateExtraCalc ä¸­ï¼Œä¸¦ç”±è¼¸å…¥æ¡†çš„ 'input' äº‹ä»¶è§¸ç™¼ã€‚
            // è‹¥ HTML ä¸­ä»æœ‰ç›´æ¥å‘¼å« calculateDifference() çš„åœ°æ–¹ï¼Œæ‡‰è€ƒæ…®ç§»é™¤æˆ–æ”¹ç”¨ updateExtraCalc()ã€‚
            function calculateDifference(){ // æ­¤å‡½æ•¸ç›®å‰æœªè¢«ç›´æ¥ä½¿ç”¨ï¼Œä½†ä¿ç•™ä»¥é˜²è¬ä¸€ (æˆ–å¯ç§»é™¤)
                const reportInput = document.getElementById('report-total');
                const collectInput = document.getElementById('collect-amount');
                const pcInput = document.getElementById('pc-amount');
                const extraCalcResultEl = document.getElementById('extra-calc-result');

                const report = reportInput ? parseInt(reportInput.value.replace(/,/g,''))||0 : 0;
                const collect = collectInput ? parseInt(collectInput.value.replace(/,/g,''))||0 : 0;
                const pc = pcInput ? parseInt(pcInput.value.replace(/,/g,''))||0 : 0;
                
                const diff = (collect - report) - pc;
                if (extraCalcResultEl) extraCalcResultEl.textContent='è¨ˆç®—çµæœï¼š'+diff.toLocaleString('zh-TW')+' å…ƒ';
            }
        </script>
    </body>
    </html>
